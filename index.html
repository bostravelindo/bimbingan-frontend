<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Bimbingan Skripsi & Repository - FEBI UINSI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --light-color: #f9fafb;
            --dark-color: #1f2937;
            --gray-color: #6b7280;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --excel-color: #217346;
            --excel-light: #e6f4ea;
            --csv-color: #1d428a;
            --csv-light: #e8f0fe;
            --print-color: #4b5563;
            --print-light: #f3f4f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f3f4f6;
            color: var(--dark-color);
            overflow-x: hidden;
        }

        /* Top Navigation */
        .top-nav {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1rem 2rem;
            box-shadow: var(--box-shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-section h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .logo-section .subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .top-menu {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .top-menu a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .top-menu a:hover, .top-menu a.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            text-align: right;
        }

        .user-info .username {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-info .role {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            min-height: calc(100vh - 72px);
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: white;
            box-shadow: var(--box-shadow);
            padding: 1.5rem 0;
            transition: var(--transition);
            position: fixed;
            height: calc(100vh - 72px);
            overflow-y: auto;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0 1rem;
        }

        .sidebar-menu li {
            margin-bottom: 0.5rem;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            text-decoration: none;
            color: var(--dark-color);
            border-radius: var(--border-radius);
            transition: var(--transition);
            font-weight: 500;
        }

        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: var(--primary-color);
            color: white;
        }

        .sidebar-menu i {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 2rem;
            transition: var(--transition);
        }

        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .stat-info {
            flex: 1;
        }

        .stat-title {
            font-size: 0.875rem;
            color: var(--gray-color);
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-change {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-change.positive {
            color: var(--success-color);
        }

        .stat-change.negative {
            color: var(--danger-color);
        }

        /* Content Sections */
        .content-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--box-shadow);
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--primary-color);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .section-actions {
            display: flex;
            gap: 0.75rem;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f9fafb;
        }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-secondary {
            background: var(--gray-color);
            color: white;
        }

        .btn-info {
            background: var(--info-color);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        /* Laporan Buttons */
        .btn-excel {
            background: var(--excel-light);
            color: var(--excel-color);
            border: 1px solid var(--excel-color);
        }

        .btn-excel:hover {
            background: #d1f0d9;
        }

        .btn-csv {
            background: var(--csv-light);
            color: var(--csv-color);
            border: 1px solid var(--csv-color);
        }

        .btn-csv:hover {
            background: #d9e4fc;
        }

        .btn-print {
            background: var(--print-light);
            color: var(--print-color);
            border: 1px solid var(--print-color);
        }

        .btn-print:hover {
            background: #e5e7eb;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: var(--border-radius);
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 1.5rem;
            background: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            background: #f9fafb;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* File Upload */
        .file-upload {
            border: 2px dashed #d1d5db;
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .file-upload:hover {
            border-color: var(--primary-color);
            background: #f9fafb;
        }

        .file-upload i {
            font-size: 2rem;
            color: var(--gray-color);
            margin-bottom: 0.5rem;
        }

        .file-upload p {
            color: var(--gray-color);
            margin: 0.5rem 0;
        }

        .file-upload small {
            color: var(--gray-color);
            font-size: 0.75rem;
        }

        /* Similarity Checker */
        .similarity-result {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: var(--border-radius);
            background: #f9fafb;
        }

        .similarity-bar {
            width: 100%;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .similarity-fill {
            height: 100%;
            background: var(--warning-color);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .similarity-fill.low {
            background: var(--success-color);
        }

        .similarity-fill.high {
            background: var(--danger-color);
        }

        /* Similarity Details */
        .similarity-details {
            margin-top: 1rem;
            border-top: 1px solid #e5e7eb;
            padding-top: 1rem;
        }

        .similar-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: var(--border-radius);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .similar-item-header {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .similar-item-detail {
            font-size: 0.875rem;
            color: var(--gray-color);
        }

        .decision-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 500;
            margin-top: 0.5rem;
        }

        .decision-diterima {
            background: #d1fae5;
            color: #065f46;
        }

        .decision-diperbaiki {
            background: #fef3c7;
            color: #92400e;
        }

        .decision-ditolak {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Progress Bar */
        .progress-container {
            margin: 2rem 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .top-menu {
                display: none;
            }

            .sidebar {
                width: 220px;
            }

            .main-content {
                margin-left: 220px;
            }

            .stats-container {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .top-nav {
                padding: 1rem;
            }

            .logo-section h1 {
                font-size: 1.25rem;
            }

            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
            }

            .main-content {
                margin-left: 0;
            }

            .table-container {
                font-size: 0.875rem;
            }

            th, td {
                padding: 0.5rem;
            }
        }

        /* GitHub Storage Badge */
        .github-badge {
            background: #2563eb;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .github-badge i {
            font-size: 1rem;
        }

        /* Footer */
        .footer {
            background: var(--dark-color);
            color: white;
            text-align: center;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .footer p {
            margin: 0.25rem 0;
        }

        /* Status Badges */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .action-btn i {
            margin-right: 0.25rem;
        }

        /* Loading Spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 3000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.active {
            transform: translateX(0);
        }

        .toast i {
            font-size: 1.25rem;
        }

        .toast-success {
            border-left: 4px solid var(--success-color);
        }

        .toast-success i {
            color: var(--success-color);
        }

        .toast-error {
            border-left: 4px solid var(--danger-color);
        }

        .toast-error i {
            color: var(--danger-color);
        }

        .toast-warning {
            border-left: 4px solid var(--warning-color);
        }

        .toast-warning i {
            color: var(--warning-color);
        }

        /* Refresh Button */
        .refresh-btn {
            background: #6b7280;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .refresh-btn:hover {
            background: #4b5563;
            transform: translateY(-2px);
        }

        /* Admin Panel Badge */
        .admin-badge {
            background: #ef4444;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        /* Validation Error */
        .validation-error {
            color: var(--danger-color);
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }

        .validation-error.show {
            display: block;
        }

        /* Submit Button Loading State */
        .btn-submit {
            position: relative;
            padding-left: 2rem;
        }

        .btn-submit.loading {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn-submit.loading::after {
            content: "";
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 1rem;
            height: 1rem;
            border: 2px solid white;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Bimbingan History */
        .bimbingan-history {
            margin-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
            padding-top: 1rem;
        }

        .history-item {
            background: #f9fafb;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 0.75rem;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .history-content {
            font-size: 0.875rem;
            color: var(--gray-color);
        }

        /* Edit Mode Indicator */
        .edit-mode-indicator {
            background: #fef3c7;
            color: #92400e;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            font-weight: 500;
            text-align: center;
        }

        /* Detail Bimbingan Modal */
        .detail-bimbingan {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-top: 1rem;
        }

        .detail-item {
            margin-bottom: 0.75rem;
        }

        .detail-label {
            font-weight: 600;
            color: var(--gray-color);
            margin-bottom: 0.25rem;
            display: block;
        }

        .detail-value {
            background: white;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            border: 1px solid #e5e7eb;
        }

        /* Repository Abstract Modal */
        .abstract-content {
            background: #f9fafb;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-top: 1rem;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }

        /* Google Drive Viewer */
        .google-drive-container {
            margin-top: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .google-drive-container iframe {
            width: 100%;
            height: 500px;
            border: none;
        }

        /* Warning Row Highlight */
        .warning-row {
            background-color: #fef3c7 !important;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }

        /* Repository Table */
        .repository-actions {
            display: flex;
            gap: 0.25rem;
        }

        .btn-view {
            background: #3b82f6;
            color: white;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .btn-upload {
            background: #10b981;
            color: white;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .btn-edit {
            background: #f59e0b;
            color: white;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        /* Admin Controls */
        .admin-controls {
            background: #dbeafe;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-color);
        }

        .admin-controls h4 {
            margin-top: 0;
            color: var(--primary-color);
            font-weight: 600;
        }

        .admin-controls p {
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--gray-color);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #d1d5db;
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="logo-section">
            <i class="fas fa-graduation-cap fa-2x"></i>
            <div>
                <h1>FEBI UINSI Samarinda</h1>
                <div class="subtitle">Dashboard Bimbingan Skripsi & Repository</div>
            </div>
        </div>
        <div class="top-menu">
            <a href="#" class="active" onclick="showSection('dashboard')"><i class="fas fa-home"></i> Dashboard</a>
            <a href="#" onclick="showSection('pengajuan')"><i class="fas fa-file-alt"></i> Pengajuan Proposal</a>
            <a href="#" onclick="showSection('bimbingan')"><i class="fas fa-chalkboard-teacher"></i> Proses Bimbingan</a>
            <a href="#" onclick="showSection('early-warning')"><i class="fas fa-exclamation-triangle"></i> Early Warning</a>
            <a href="#" onclick="showSection('repository')"><i class="fas fa-database"></i> Skripsi Repository</a>
        </div>
        <div class="user-section" id="userSection">
            <div class="user-info">
                <div class="username" id="userName">Guest</div>
                <div class="role" id="userRole">Belum Login</div>
            </div>
            <div class="user-avatar" id="userAvatar">G</div>
            <button class="btn btn-primary" onclick="showLoginModal()"><i class="fas fa-sign-in-alt"></i> Login/Daftar</button>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="#" class="active" onclick="showSection('dashboard')"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="#" onclick="showSection('pengajuan')"><i class="fas fa-file-alt"></i> Pengajuan Proposal</a></li>
                <li><a href="#" onclick="showSection('bimbingan')"><i class="fas fa-chalkboard-teacher"></i> Proses Bimbingan</a></li>
                <li><a href="#" onclick="showSection('data-mahasiswa')" id="menuDataMahasiswa" style="display: none;"><i class="fas fa-user-graduate"></i> Data Mahasiswa <span class="admin-badge">Admin</span></a></li>
                <li><a href="#" onclick="showSection('data-dosen')" id="menuDataDosen" style="display: none;"><i class="fas fa-chalkboard-teacher"></i> Data Dosen <span class="admin-badge">Admin</span></a></li>
                <li><a href="#" onclick="showSection('early-warning')"><i class="fas fa-exclamation-triangle"></i> Early Warning</a></li>
                <li><a href="#" onclick="showSection('repository')"><i class="fas fa-database"></i> Skripsi Repository</a></li>
                <li><a href="#" onclick="showSection('laporan')"><i class="fas fa-file-pdf"></i> Laporan</a></li>
                <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-home"></i> Dashboard</h2>
                    <div>
                        <span id="currentTime"></span>
                        <button class="refresh-btn" onclick="forceRefresh()" title="Refresh Data">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <p>Selamat datang di Dashboard Bimbingan Skripsi & Repository FEBI UINSI Samarinda. Sistem ini memudahkan pengelolaan bimbingan skripsi dan penyimpanan repository skripsi secara permanen.</p>
                
                <div class="github-badge">
                    <i class="fab fa-github"></i>
                    <span>GitHub Permanent Storage Active - Data tersimpan permanen di GitHub dan dapat diakses dari device manapun!</span>
                </div>

                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #2563eb;">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-title">Proposal Masuk</div>
                            <div class="stat-value" id="proposalCount">0</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>+2 hari ini</span>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: #10b981;">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-title">Bimbingan Berjalan</div>
                            <div class="stat-value" id="bimbinganCount">0</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>+1 hari ini</span>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: #f59e0b;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-title">Selesai</div>
                            <div class="stat-value" id="selesaiCount">0</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>+3 bulan ini</span>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: #ef4444;">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-title">Early Warning</div>
                            <div class="stat-value" id="warningCount">0</div>
                            <div class="stat-change negative">
                                <i class="fas fa-arrow-down"></i>
                                <span>-1 minggu ini</span>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: #3b82f6;">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-title">Repository</div>
                            <div class="stat-value" id="repositoryCount">0</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>+5 baru</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </section>

            <!-- Pengajuan Proposal Section -->
            <section id="pengajuan" class="content-section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-file-alt"></i> Pengajuan Proposal</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="showPengajuanForm()" id="btnAjukanProposal">
                            <i class="fas fa-plus"></i> Ajukan Proposal Baru
                        </button>
                        <button class="btn btn-success" onclick="exportData('proposal')" id="btnExportProposal">
                            <i class="fas fa-file-export"></i> Export Data
                        </button>
                        <button class="btn btn-info" onclick="printData('proposal')" id="btnPrintProposal">
                            <i class="fas fa-print"></i> Print Data
                        </button>
                    </div>
                </div>
                <p>Kelola pengajuan proposal skripsi. Tabel berikut menampilkan data proposal berdasarkan peran Anda.</p>
                
                <div class="admin-controls" id="adminProposalControls" style="display: none;">
                    <h4><i class="fas fa-shield-alt"></i> Mode Admin - Akses Penuh ke Semua Data</h4>
                    <p>Sebagai admin, Anda memiliki akses penuh untuk melihat, mengedit, memvalidasi, dan menghapus semua proposal.</p>
                </div>

                <div class="table-container">
                    <table id="proposalTable">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>NIM</th>
                                <th>Nama Mahasiswa</th>
                                <th>Judul Proposal</th>
                                <th>Pembimbing 1</th>
                                <th>Pembimbing 2</th>
                                <th>Similarity</th>
                                <th>Status</th>
                                <th>Tanggal</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="proposalTableBody">
                            <tr>
                                <td colspan="10" style="text-align: center;">Loading data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Proses Bimbingan Section -->
            <section id="bimbingan" class="content-section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-chalkboard-teacher"></i> Proses Bimbingan</h2>
                    <div class="section-actions">
                        <button class="btn btn-success" onclick="exportData('bimbingan')">
                            <i class="fas fa-file-export"></i> Export Data
                        </button>
                        <button class="btn btn-info" onclick="printData('bimbingan')">
                            <i class="fas fa-print"></i> Print Data
                        </button>
                    </div>
                </div>
                <p>Kelola proses bimbingan skripsi dari Bab 1 hingga selesai.</p>
                
                <div class="admin-controls" id="adminBimbinganControls" style="display: none;">
                    <h4><i class="fas fa-shield-alt"></i> Mode Admin - Akses Penuh ke Semua Data Bimbingan</h4>
                    <p>Sebagai admin, Anda dapat melihat semua proses bimbingan dari seluruh mahasiswa dan dosen.</p>
                </div>

                <div class="progress-container">
                    <div>Progress Bimbingan: <strong id="progressPercentage">0%</strong></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>

                <div class="table-container">
                    <table id="bimbinganTable">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>NIM</th>
                                <th>Nama Mahasiswa</th>
                                <th>Judul</th>
                                <th>Pembimbing 1</th>
                                <th>Pembimbing 2</th>
                                <th>Bab Terakhir</th>
                                <th>Status</th>
                                <th>Tanggal</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="bimbinganTableBody">
                            <tr>
                                <td colspan="10" style="text-align: center;">Loading data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Data Mahasiswa Section (Admin Only) -->
            <section id="data-mahasiswa" class="content-section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-user-graduate"></i> Data Mahasiswa <span class="admin-badge">Admin Panel</span></h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="showTambahMahasiswaModal()">
                            <i class="fas fa-plus"></i> Tambah Mahasiswa
                        </button>
                        <button class="btn btn-success" onclick="exportData('mahasiswa')">
                            <i class="fas fa-file-export"></i> Export Data
                        </button>
                        <button class="btn btn-info" onclick="printData('mahasiswa')">
                            <i class="fas fa-print"></i> Print Data
                        </button>
                    </div>
                </div>
                <p>Kelola data mahasiswa yang terdaftar dalam sistem.</p>

                <div class="table-container">
                    <table id="mahasiswaTable">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>NIM</th>
                                <th>Nama Lengkap</th>
                                <th>Email</th>
                                <th>WhatsApp</th>
                                <th>Program Studi</th>
                                <th>Tanggal Daftar</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="mahasiswaTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center;">Loading data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Data Dosen Section (Admin Only) -->
            <section id="data-dosen" class="content-section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-chalkboard-teacher"></i> Data Dosen <span class="admin-badge">Admin Panel</span></h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="showTambahDosenModal()">
                            <i class="fas fa-plus"></i> Tambah Dosen
                        </button>
                        <button class="btn btn-success" onclick="exportData('dosen')">
                            <i class="fas fa-file-export"></i> Export Data
                        </button>
                        <button class="btn btn-info" onclick="printData('dosen')">
                            <i class="fas fa-print"></i> Print Data
                        </button>
                    </div>
                </div>
                <p>Kelola data dosen yang terdaftar dalam sistem.</p>

                <div class="table-container">
                    <table id="dosenTable">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>NIP/NIDN</th>
                                <th>Nama Lengkap</th>
                                <th>Email</th>
                                <th>WhatsApp</th>
                                <th>Tanggal Daftar</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="dosenTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center;">Loading data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Early Warning Section -->
            <section id="early-warning" class="content-section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-exclamation-triangle"></i> Early Warning System</h2>
                    <div class="section-actions">
                        <button class="btn btn-success" onclick="exportData('early-warning')">
                            <i class="fas fa-file-export"></i> Export Data
                        </button>
                        <button class="btn btn-info" onclick="printData('early-warning')">
                            <i class="fas fa-print"></i> Print Data
                        </button>
                    </div>
                </div>
                <p>Sistem peringatan dini untuk mahasiswa semester 11-14 yang belum menyelesaikan skripsi.</p>
                <div style="background: #fef3c7; padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                    <strong><i class="fas fa-exclamation-triangle"></i> Peringatan:</strong> Mahasiswa semester 11-14 harus segera menyelesaikan skripsi untuk menghindari DO (Drop Out).
                </div>

                <div class="table-container">
                    <table id="warningTable">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>NIM</th>
                                <th>Nama</th>
                                <th>Program Studi</th>
                                <th>Semester</th>
                                <th>Status Skripsi</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="warningTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center;">Loading data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Repository Section -->
            <section id="repository" class="content-section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-database"></i> Skripsi Repository</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="showTambahRepositoryModal()" id="btnTambahRepository" style="display: none;">
                            <i class="fas fa-plus"></i> Tambah Repository
                        </button>
                        <button class="btn btn-success" onclick="exportData('repository')">
                            <i class="fas fa-file-export"></i> Export Data
                        </button>
                        <button class="btn btn-info" onclick="printData('repository')">
                            <i class="fas fa-print"></i> Print Data
                        </button>
                    </div>
                </div>
                <p>Cari dan lihat skripsi-skripsi yang telah disimpan dalam repository.</p>

                <div class="form-group" style="margin-bottom: 1rem;">
                    <input type="text" class="form-control" placeholder="Cari judul skripsi..." onkeyup="searchRepository(this.value)">
                </div>

                <div class="table-container">
                    <table id="repositoryTable">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Judul</th>
                                <th>Penulis</th>
                                <th>Tahun</th>
                                <th>Program Studi</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="repositoryTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center;">Loading data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Laporan Section -->
            <section id="laporan" class="content-section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-file-pdf"></i> Laporan</h2>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                    <button class="btn btn-excel" onclick="exportExcel()">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                    <button class="btn btn-csv" onclick="exportCSV()">
                        <i class="fas fa-file-csv"></i> Export CSV
                    </button>
                    <button class="btn btn-print" onclick="printAllData()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2026 FEBI UINSI SAMARINDA</p>
        <p>Managed by Iskandar</p>
    </footer>

    <!-- Modals -->
    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Login Sistem</h3>
                <button class="modal-close" onclick="closeModal('loginModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="loginId">NIM / NIP / ID</label>
                    <input type="text" class="form-control" id="loginId" placeholder="Masukkan NIM, NIP, atau ID">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" class="form-control" id="loginPassword" placeholder="Masukkan password">
                </div>
                <div style="text-align: center; margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="login()">Login</button>
                    <button class="btn btn-secondary" onclick="showRegisterModal()">Daftar Baru</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Daftar Akun Baru</h3>
                <button class="modal-close" onclick="closeModal('registerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="userType">Jenis Pengguna *</label>
                    <select class="form-control" id="userType" onchange="toggleRegisterFields()">
                        <option value="">-- Pilih Jenis Pengguna --</option>
                        <option value="mahasiswa">Mahasiswa</option>
                        <option value="dosen">Dosen</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="registerId">NIM / NIP *</label>
                        <input type="text" class="form-control" id="registerId" placeholder="Masukkan NIM atau NIP">
                    </div>
                    <div class="form-group">
                        <label for="registerName">Nama Lengkap *</label>
                        <input type="text" class="form-control" id="registerName" placeholder="Masukkan nama lengkap">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="registerEmail">Email *</label>
                        <input type="email" class="form-control" id="registerEmail" placeholder="Masukkan email">
                    </div>
                    <div class="form-group">
                        <label for="registerWhatsApp">WhatsApp *</label>
                        <input type="text" class="form-control" id="registerWhatsApp" placeholder="Masukkan nomor WhatsApp">
                    </div>
                </div>
                <div class="form-group" id="prodiField">
                    <label for="registerProdi">Program Studi *</label>
                    <select class="form-control" id="registerProdi">
                        <option value="">-- Pilih Program Studi --</option>
                        <option value="Ekonomi Syariah">Ekonomi Syariah</option>
                        <option value="Perbankan Syariah">Perbankan Syariah</option>
                        <option value="Manajemen Bisnis Syariah">Manajemen Bisnis Syariah</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="registerPassword">Password *</label>
                        <input type="password" class="form-control" id="registerPassword" placeholder="Masukkan password">
                    </div>
                    <div class="form-group">
                        <label for="registerConfirmPassword">Konfirmasi Password *</label>
                        <input type="password" class="form-control" id="registerConfirmPassword" placeholder="Konfirmasi password">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('registerModal')">Batal</button>
                    <button class="btn btn-primary" onclick="register()">Daftar Akun</button>
                </div>
                <div style="text-align: center; margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="showLoginModal()">Sudah Punya Akun?</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pengajuan Proposal Modal -->
    <div class="modal" id="pengajuanModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Form Pengajuan Proposal</h3>
                <button class="modal-close" onclick="closeModal('pengajuanModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="editModeIndicator" class="edit-mode-indicator" style="display: none;">
                    <i class="fas fa-edit"></i> Mode Edit Proposal - Mengubah data proposal yang sudah ada
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="nim">NIM *</label>
                        <input type="text" class="form-control" id="nim" readonly>
                    </div>
                    <div class="form-group">
                        <label for="namaLengkap">Nama Lengkap *</label>
                        <input type="text" class="form-control" id="namaLengkap" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="email">Email *</label>
                        <input type="email" class="form-control" id="email" readonly>
                    </div>
                    <div class="form-group">
                        <label for="whatsapp">WhatsApp *</label>
                        <input type="text" class="form-control" id="whatsapp" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label for="prodi">Program Studi *</label>
                    <select class="form-control" id="prodi" disabled>
                        <option value="">-- Pilih Program Studi --</option>
                        <option value="Ekonomi Syariah">Ekonomi Syariah</option>
                        <option value="Perbankan Syariah">Perbankan Syariah</option>
                        <option value="Manajemen Bisnis Syariah">Manajemen Bisnis Syariah</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="judulProposal">Judul Proposal *</label>
                    <input type="text" class="form-control" id="judulProposal" placeholder="Masukkan judul proposal" onkeyup="checkSimilarity()">
                    <div class="validation-error" id="errorJudul"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pembimbing1">Dosen Pembimbing 1 *</label>
                        <select class="form-control" id="pembimbing1" onchange="validatePembimbing()">
                            <option value="">-- Pilih Dosen Pembimbing 1 --</option>
                        </select>
                        <div class="validation-error" id="errorPembimbing1"></div>
                    </div>
                    <div class="form-group">
                        <label for="pembimbing2">Dosen Pembimbing 2</label>
                        <select class="form-control" id="pembimbing2" onchange="validatePembimbing()">
                            <option value="">-- Pilih Dosen Pembimbing 2 (Opsional) --</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="fileProposal">Upload File Proposal (PDF, Max 5MB) *</label>
                    <div class="file-upload" onclick="document.getElementById('fileProposal').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Klik untuk upload file proposal</p>
                        <small>Format: PDF (Maksimal 5MB)</small>
                        <input type="file" id="fileProposal" accept=".pdf" style="display: none;" onchange="handleFileUpload(this)">
                    </div>
                    <div id="fileInfo" style="margin-top: 0.5rem; display: none;">
                        <i class="fas fa-file-pdf"></i> <span id="fileName">proposal.pdf</span>
                        <button class="btn btn-danger btn-sm" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem;" onclick="removeFileUpload()">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                    </div>
                    <div class="validation-error" id="errorFile"></div>
                </div>
                <div id="similarityResult" class="similarity-result" style="display: none;">
                    <strong>Hasil Cek Similarity:</strong>
                    <div id="similarityPercentage">0%</div>
                    <div class="similarity-bar">
                        <div class="similarity-fill" id="similarityFill" style="width: 0%"></div>
                    </div>
                    <div id="similarityStatus" style="margin-top: 0.5rem;"></div>
                    <div id="similarityDetails" class="similarity-details" style="display: none;">
                        <h4>Proposal/Skripsi dengan Kemiripan Tinggi:</h4>
                        <div id="similarItemsList"></div>
                    </div>
                    <div id="similarityDecision" style="margin-top: 1rem;"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('pengajuanModal')">Batal</button>
                    <button class="btn btn-primary btn-submit" id="btnSubmitProposal" onclick="submitProposal()">
                        <i class="fas fa-paper-plane"></i> <span id="submitButtonText">Ajukan Proposal</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Validasi Proposal Modal -->
    <div class="modal" id="validasiModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Validasi Proposal</h3>
                <button class="modal-close" onclick="closeModal('validasiModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="validasiStatus">Status Proposal *</label>
                    <select class="form-control" id="validasiStatus">
                        <option value="Diterima">Diterima</option>
                        <option value="Diperbaiki">Diperbaiki</option>
                        <option value="Ditolak">Ditolak</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="validasiKomentar">Komentar/Alasan *</label>
                    <textarea class="form-control" id="validasiKomentar" rows="4" placeholder="Masukkan komentar atau alasan validasi"></textarea>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('validasiModal')">Batal</button>
                    <button class="btn btn-success btn-submit" id="btnValidasiProposal" onclick="validateProposal()">
                        <i class="fas fa-check"></i> Validasi Proposal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Bimbingan Modal -->
    <div class="modal" id="bimbinganModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Form Bimbingan</h3>
                <button class="modal-close" onclick="closeModal('bimbinganModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="bimbinganBab">Bab *</label>
                    <select class="form-control" id="bimbinganBab">
                        <option value="">-- Pilih Bab --</option>
                        <option value="Bab 1 - Pendahuluan">Bab 1 - Pendahuluan</option>
                        <option value="Bab 2 - Landasan Teori">Bab 2 - Landasan Teori</option>
                        <option value="Bab 3 - Metodologi Penelitian">Bab 3 - Metodologi Penelitian</option>
                        <option value="Bab 4 - Hasil dan Pembahasan">Bab 4 - Hasil dan Pembahasan</option>
                        <option value="Bab 5 - Kesimpulan dan Saran">Bab 5 - Kesimpulan dan Saran</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="bimbinganKomentar">Komentar/Saran *</label>
                    <textarea class="form-control" id="bimbinganKomentar" rows="4" placeholder="Masukkan komentar atau saran"></textarea>
                </div>
                <div class="form-group">
                    <label for="bimbinganStatus">Status *</label>
                    <select class="form-control" id="bimbinganStatus">
                        <option value="Perlu Revisi">Perlu Revisi</option>
                        <option value="Diterima">Diterima</option>
                        <option value="Selesai">Selesai</option>
                    </select>
                </div>
                
                <div class="bimbingan-history" id="bimbinganHistory" style="display: none;">
                    <h4>Riwayat Bimbingan</h4>
                    <div id="historyList"></div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('bimbinganModal')">Batal</button>
                    <button class="btn btn-primary btn-submit" id="btnKirimBimbingan" onclick="submitBimbingan()">
                        <i class="fas fa-paper-plane"></i> Kirim Bimbingan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Bimbingan Modal -->
    <div class="modal" id="detailBimbinganModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Detail Bimbingan</h3>
                <button class="modal-close" onclick="closeModal('detailBimbinganModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="detail-bimbingan">
                    <div class="detail-item">
                        <span class="detail-label">Bab</span>
                        <div class="detail-value" id="detailBab"></div>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Komentar/Saran</span>
                        <div class="detail-value" id="detailKomentar"></div>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Status</span>
                        <div class="detail-value" id="detailStatus"></div>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Dosen Pembimbing</span>
                        <div class="detail-value" id="detailDosen"></div>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Tanggal</span>
                        <div class="detail-value" id="detailTanggal"></div>
                    </div>
                </div>
                
                <div class="bimbingan-history" id="detailHistory" style="display: none;">
                    <h4>Riwayat Bimbingan</h4>
                    <div id="detailHistoryList"></div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('detailBimbinganModal')">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Riwayat Bimbingan Modal (Khusus Mahasiswa) -->
    <div class="modal" id="riwayatBimbinganModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Riwayat Bimbingan Proposal</h3>
                <button class="modal-close" onclick="closeModal('riwayatBimbinganModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="bimbingan-history">
                    <h4>Riwayat Bimbingan</h4>
                    <div id="riwayatHistoryList"></div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('riwayatBimbinganModal')">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tambah Repository Modal (Admin) -->
    <div class="modal" id="tambahRepositoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Tambah Skripsi Repository</h3>
                <button class="modal-close" onclick="closeModal('tambahRepositoryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="repoJudul">Judul Skripsi *</label>
                    <input type="text" class="form-control" id="repoJudul" placeholder="Masukkan judul skripsi">
                </div>
                <div class="form-group">
                    <label for="repoPenulis">Penulis *</label>
                    <input type="text" class="form-control" id="repoPenulis" placeholder="Masukkan nama penulis">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="repoTahun">Tahun *</label>
                        <input type="number" class="form-control" id="repoTahun" placeholder="Masukkan tahun" value="2026">
                    </div>
                    <div class="form-group">
                        <label for="repoProdi">Program Studi *</label>
                        <select class="form-control" id="repoProdi">
                            <option value="">-- Pilih Program Studi --</option>
                            <option value="Ekonomi Syariah">Ekonomi Syariah</option>
                            <option value="Perbankan Syariah">Perbankan Syariah</option>
                            <option value="Manajemen Bisnis Syariah">Manajemen Bisnis Syariah</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="repoAbstrak">Abstrak *</label>
                    <textarea class="form-control" id="repoAbstrak" rows="6" placeholder="Masukkan abstrak penelitian"></textarea>
                </div>
                <div class="form-group">
                    <label for="repoGoogleDrive">Google Drive URL *</label>
                    <input type="url" class="form-control" id="repoGoogleDrive" placeholder="https://drive.google.com/file/d/...">
                    <small style="color: var(--gray-color);">Masukkan URL file Google Drive yang dapat diakses publik</small>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('tambahRepositoryModal')">Batal</button>
                    <button class="btn btn-primary" onclick="saveRepository()">Simpan Repository</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Repository Modal (Admin) -->
    <div class="modal" id="editRepositoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Skripsi Repository</h3>
                <button class="modal-close" onclick="closeModal('editRepositoryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editRepositoryId">
                <div class="form-group">
                    <label for="editRepoJudul">Judul Skripsi *</label>
                    <input type="text" class="form-control" id="editRepoJudul" placeholder="Masukkan judul skripsi">
                </div>
                <div class="form-group">
                    <label for="editRepoPenulis">Penulis *</label>
                    <input type="text" class="form-control" id="editRepoPenulis" placeholder="Masukkan nama penulis">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editRepoTahun">Tahun *</label>
                        <input type="number" class="form-control" id="editRepoTahun" placeholder="Masukkan tahun">
                    </div>
                    <div class="form-group">
                        <label for="editRepoProdi">Program Studi *</label>
                        <select class="form-control" id="editRepoProdi">
                            <option value="">-- Pilih Program Studi --</option>
                            <option value="Ekonomi Syariah">Ekonomi Syariah</option>
                            <option value="Perbankan Syariah">Perbankan Syariah</option>
                            <option value="Manajemen Bisnis Syariah">Manajemen Bisnis Syariah</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editRepoAbstrak">Abstrak *</label>
                    <textarea class="form-control" id="editRepoAbstrak" rows="6" placeholder="Masukkan abstrak penelitian"></textarea>
                </div>
                <div class="form-group">
                    <label for="editRepoGoogleDrive">Google Drive URL *</label>
                    <input type="url" class="form-control" id="editRepoGoogleDrive" placeholder="https://drive.google.com/file/d/...">
                    <small style="color: var(--gray-color);">Masukkan URL file Google Drive yang dapat diakses publik</small>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('editRepositoryModal')">Batal</button>
                    <button class="btn btn-primary" onclick="updateRepository()">Update Repository</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Abstract Modal -->
    <div class="modal" id="viewAbstractModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Abstrak Skripsi</h3>
                <button class="modal-close" onclick="closeModal('viewAbstractModal')">&times;</button>
            </div>
            <div class="modal-body">
                <h4 id="abstractTitle"></h4>
                <div class="abstract-content" id="abstractContent">
                    Loading abstrak...
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('viewAbstractModal')">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Google Drive Modal -->
    <div class="modal" id="viewGoogleDriveModal">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh;">
            <div class="modal-header">
                <h3 class="modal-title">File Skripsi</h3>
                <button class="modal-close" onclick="closeModal('viewGoogleDriveModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="google-drive-container">
                    <iframe id="googleDriveFrame" src="about:blank" frameborder="0"></iframe>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('viewGoogleDriveModal')">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tambah Mahasiswa Modal (Admin) -->
    <div class="modal" id="tambahMahasiswaModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Tambah Data Mahasiswa</h3>
                <button class="modal-close" onclick="closeModal('tambahMahasiswaModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="nimBaru">NIM *</label>
                        <input type="text" class="form-control" id="nimBaru" placeholder="Masukkan NIM">
                    </div>
                    <div class="form-group">
                        <label for="namaMahasiswaBaru">Nama Lengkap *</label>
                        <input type="text" class="form-control" id="namaMahasiswaBaru" placeholder="Masukkan nama lengkap">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="emailMahasiswaBaru">Email *</label>
                        <input type="email" class="form-control" id="emailMahasiswaBaru" placeholder="Masukkan email">
                    </div>
                    <div class="form-group">
                        <label for="whatsappMahasiswaBaru">WhatsApp *</label>
                        <input type="text" class="form-control" id="whatsappMahasiswaBaru" placeholder="Masukkan nomor WhatsApp">
                    </div>
                </div>
                <div class="form-group">
                    <label for="prodiMahasiswaBaru">Program Studi *</label>
                    <select class="form-control" id="prodiMahasiswaBaru">
                        <option value="">-- Pilih Program Studi --</option>
                        <option value="Ekonomi Syariah">Ekonomi Syariah</option>
                        <option value="Perbankan Syariah">Perbankan Syariah</option>
                        <option value="Manajemen Bisnis Syariah">Manajemen Bisnis Syariah</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="passwordMahasiswaBaru">Password *</label>
                        <input type="password" class="form-control" id="passwordMahasiswaBaru" placeholder="Masukkan password">
                    </div>
                    <div class="form-group">
                        <label for="confirmPasswordMahasiswaBaru">Konfirmasi Password *</label>
                        <input type="password" class="form-control" id="confirmPasswordMahasiswaBaru" placeholder="Konfirmasi password">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('tambahMahasiswaModal')">Batal</button>
                    <button class="btn btn-primary" onclick="saveMahasiswaBaru()">Simpan Mahasiswa</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Mahasiswa Modal (Admin) -->
    <div class="modal" id="editMahasiswaModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Data Mahasiswa</h3>
                <button class="modal-close" onclick="closeModal('editMahasiswaModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editMahasiswaId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editNim">NIM *</label>
                        <input type="text" class="form-control" id="editNim" readonly>
                    </div>
                    <div class="form-group">
                        <label for="editNamaMahasiswa">Nama Lengkap *</label>
                        <input type="text" class="form-control" id="editNamaMahasiswa">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editEmailMahasiswa">Email *</label>
                        <input type="email" class="form-control" id="editEmailMahasiswa">
                    </div>
                    <div class="form-group">
                        <label for="editWhatsAppMahasiswa">WhatsApp *</label>
                        <input type="text" class="form-control" id="editWhatsAppMahasiswa">
                    </div>
                </div>
                <div class="form-group">
                    <label for="editProdiMahasiswa">Program Studi *</label>
                    <select class="form-control" id="editProdiMahasiswa">
                        <option value="">-- Pilih Program Studi --</option>
                        <option value="Ekonomi Syariah">Ekonomi Syariah</option>
                        <option value="Perbankan Syariah">Perbankan Syariah</option>
                        <option value="Manajemen Bisnis Syariah">Manajemen Bisnis Syariah</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('editMahasiswaModal')">Batal</button>
                    <button class="btn btn-primary" onclick="updateMahasiswa()">Update Mahasiswa</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tambah Dosen Modal (Admin) -->
    <div class="modal" id="tambahDosenModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Tambah Data Dosen</h3>
                <button class="modal-close" onclick="closeModal('tambahDosenModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="nipBaru">NIP/NIDN *</label>
                        <input type="text" class="form-control" id="nipBaru" placeholder="Masukkan NIP atau NIDN">
                    </div>
                    <div class="form-group">
                        <label for="namaDosenBaru">Nama Lengkap *</label>
                        <input type="text" class="form-control" id="namaDosenBaru" placeholder="Masukkan nama lengkap">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="emailDosenBaru">Email *</label>
                        <input type="email" class="form-control" id="emailDosenBaru" placeholder="Masukkan email">
                    </div>
                    <div class="form-group">
                        <label for="whatsappDosenBaru">WhatsApp *</label>
                        <input type="text" class="form-control" id="whatsappDosenBaru" placeholder="Masukkan nomor WhatsApp">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="passwordDosenBaru">Password *</label>
                        <input type="password" class="form-control" id="passwordDosenBaru" placeholder="Masukkan password">
                    </div>
                    <div class="form-group">
                        <label for="confirmPasswordDosenBaru">Konfirmasi Password *</label>
                        <input type="password" class="form-control" id="confirmPasswordDosenBaru" placeholder="Konfirmasi password">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('tambahDosenModal')">Batal</button>
                    <button class="btn btn-primary" onclick="saveDosenBaru()">Simpan Dosen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Dosen Modal (Admin) -->
    <div class="modal" id="editDosenModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Data Dosen</h3>
                <button class="modal-close" onclick="closeModal('editDosenModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editDosenId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editNip">NIP/NIDN *</label>
                        <input type="text" class="form-control" id="editNip" readonly>
                    </div>
                    <div class="form-group">
                        <label for="editNamaDosen">Nama Lengkap *</label>
                        <input type="text" class="form-control" id="editNamaDosen">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editEmailDosen">Email *</label>
                        <input type="email" class="form-control" id="editEmailDosen">
                    </div>
                    <div class="form-group">
                        <label for="editWhatsAppDosen">WhatsApp *</label>
                        <input type="text" class="form-control" id="editWhatsAppDosen">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('editDosenModal')">Batal</button>
                    <button class="btn btn-primary" onclick="updateDosen()">Update Dosen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toastNotification">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Notifikasi berhasil!</span>
    </div>

    <script>
        // ========================================
        // GLOBAL VARIABLES
        // ========================================
        let currentUser = null;
        let proposals = [];
        let bimbingans = [];
        let users = [];
        let repositories = [];
        let currentProposalId = null;
        let currentBimbinganId = null;
        let currentMahasiswaId = null;
        let currentDosenId = null;
        let currentRepositoryId = null;
        let uploadedFile = null;
        let isSubmitting = false;
        let isEditingProposal = false;
        let currentEditProposalId = null;

        // ========================================
        // GITHUB API CONFIGURATION
        // ========================================
        const GITHUB_TOKEN = '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';
        const GITHUB_OWNER = 'bostravelindo';
        const GITHUB_REPO = 'bimbingan-data';
        const GITHUB_API_URL = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents`;

        // ========================================
        // EARLY WARNING SYSTEM - IDENTIFIKASI SEMESTER DARI NIM
        // ========================================
        function getSemesterFromNIM(nim) {
            const yearPrefix = nim.substring(0, 2);
            const currentYear = new Date().getFullYear();
            const currentShortYear = parseInt(String(currentYear).substring(2));
            
            let semester = 1;
            if (yearPrefix && !isNaN(parseInt(yearPrefix))) {
                const angkatan = parseInt(yearPrefix);
                semester = (currentShortYear - angkatan) * 2 + 1;
            }
            
            return semester;
        }

        // ========================================
        // ENHANCED SIMILARITY CHECKER
        // ========================================
        function checkSimilarity() {
            const judul = document.getElementById('judulProposal').value.trim().toLowerCase();
            
            if (!judul || judul.length < 10) {
                document.getElementById('similarityResult').style.display = 'none';
                return;
            }
            
            // Show loading state
            document.getElementById('similarityResult').style.display = 'block';
            document.getElementById('similarityPercentage').textContent = 'Memeriksa...';
            document.getElementById('similarityFill').style.width = '0%';
            document.getElementById('similarityStatus').textContent = 'Sedang memeriksa kemiripan...';
            document.getElementById('similarityDetails').style.display = 'none';
            document.getElementById('similarityDecision').innerHTML = '';
            
            // Simulate async check with setTimeout
            setTimeout(() => {
                let maxSimilarity = 0;
                let similarItems = [];
                
                // Check against proposals
                proposals.forEach(proposal => {
                    if (proposal.status !== 'Ditolak') {
                        const similarity = calculateSimilarity(judul, proposal.judul.toLowerCase());
                        if (similarity > maxSimilarity) {
                            maxSimilarity = similarity;
                        }
                        if (similarity > 30) {
                            similarItems.push({
                                type: 'proposal',
                                judul: proposal.judul,
                                similarity: similarity,
                                nama: proposal.nama,
                                prodi: proposal.prodi,
                                tahun: new Date(proposal.tanggal).getFullYear(),
                                status: proposal.status
                            });
                        }
                    }
                });
                
                // Check against repositories
                repositories.forEach(repo => {
                    const similarity = calculateSimilarity(judul, repo.judul.toLowerCase());
                    if (similarity > maxSimilarity) {
                        maxSimilarity = similarity;
                    }
                    if (similarity > 30) {
                        similarItems.push({
                            type: 'repository',
                            judul: repo.judul,
                            similarity: similarity,
                            nama: repo.penulis,
                            prodi: repo.prodi,
                            tahun: repo.tahun,
                            status: 'Selesai'
                        });
                    }
                });
                
                // Display results
                document.getElementById('similarityPercentage').textContent = `${Math.round(maxSimilarity)}%`;
                
                const similarityFill = document.getElementById('similarityFill');
                similarityFill.style.width = `${maxSimilarity}%`;
                
                let decisionText = '';
                let decisionClass = '';
                
                if (maxSimilarity < 30) {
                    similarityFill.className = 'similarity-fill low';
                    document.getElementById('similarityStatus').textContent = 'Judul unik, dapat diajukan';
                    document.getElementById('similarityStatus').style.color = '#065f46';
                    decisionText = 'Diterima';
                    decisionClass = 'decision-diterima';
                } else if (maxSimilarity < 70) {
                    similarityFill.className = 'similarity-fill';
                    document.getElementById('similarityStatus').textContent = 'Ada kemiripan, perlu penyesuaian';
                    document.getElementById('similarityStatus').style.color = '#92400e';
                    decisionText = 'Diperbaiki';
                    decisionClass = 'decision-diperbaiki';
                } else {
                    similarityFill.className = 'similarity-fill high';
                    document.getElementById('similarityStatus').textContent = 'Terlalu mirip, tidak dapat diajukan';
                    document.getElementById('similarityStatus').style.color = '#991b1b';
                    decisionText = 'Ditolak';
                    decisionClass = 'decision-ditolak';
                }
                
                // Display similar items if any
                const similarItemsList = document.getElementById('similarItemsList');
                if (similarItems.length > 0) {
                    document.getElementById('similarityDetails').style.display = 'block';
                    similarItemsList.innerHTML = '';
                    
                    // Sort by similarity descending
                    similarItems.sort((a, b) => b.similarity - a.similarity);
                    
                    // Show top 5 similar items
                    similarItems.slice(0, 5).forEach(item => {
                        const itemElement = document.createElement('div');
                        itemElement.className = 'similar-item';
                        itemElement.innerHTML = `
                            <div class="similar-item-header">
                                ${item.judul} (${Math.round(item.similarity)}%)
                            </div>
                            <div class="similar-item-detail">
                                <strong>${item.type === 'proposal' ? 'Proposal oleh' : 'Skripsi oleh'}:</strong> ${item.nama}<br>
                                <strong>Program Studi:</strong> ${item.prodi}<br>
                                <strong>Tahun:</strong> ${item.tahun}<br>
                                <strong>Status:</strong> ${item.status}
                            </div>
                        `;
                        similarItemsList.appendChild(itemElement);
                    });
                } else {
                    document.getElementById('similarityDetails').style.display = 'none';
                }
                
                // Display decision
                document.getElementById('similarityDecision').innerHTML = `
                    <strong>Keputusan:</strong>
                    <span class="decision-badge ${decisionClass}">${decisionText}</span>
                `;
            }, 800);
        }

        // ========================================
        // CALCULATE SIMILARITY WITH IMPROVED ALGORITHM
        // ========================================
        function calculateSimilarity(str1, str2) {
            // Normalize strings: lowercase, remove punctuation
            const normalize = (str) => str.toLowerCase().replace(/[^\w\s]/g, '');
            
            const words1 = normalize(str1).split(/\s+/).filter(w => w.length > 2);
            const words2 = normalize(str2).split(/\s+/).filter(w => w.length > 2);
            
            if (words1.length === 0 || words2.length === 0) return 0;
            
            // Calculate Jaccard similarity
            const set1 = new Set(words1);
            const set2 = new Set(words2);
            
            const intersection = new Set([...set1].filter(x => set2.has(x)));
            const union = new Set([...set1, ...set2]);
            
            const jaccard = intersection.size / union.size;
            
            // Also calculate word overlap ratio
            let matches = 0;
            words1.forEach(word => {
                if (words2.includes(word)) matches++;
            });
            
            const overlapRatio = matches / Math.max(words1.length, words2.length);
            
            // Combine both metrics (weighted average)
            const combinedSimilarity = (jaccard * 0.6 + overlapRatio * 0.4) * 100;
            
            return combinedSimilarity;
        }

        // ========================================
        // DISPLAY WARNING DATA
        // ========================================
        function displayWarningData() {
            const tbody = document.getElementById('warningTableBody');
            
            if (!currentUser) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Silakan login untuk melihat data</td></tr>';
                return;
            }
            
            const mahasiswas = users.filter(u => u.role === 'mahasiswa');
            
            const warningMahasiswas = mahasiswas.filter(mhs => {
                const semester = getSemesterFromNIM(mhs.id);
                
                if (semester < 11 || semester > 14) {
                    return false;
                }
                
                const hasCompleted = proposals.some(p => 
                    p.nim === mhs.id && 
                    p.status === 'Selesai'
                );
                
                return !hasCompleted;
            });
            
            document.getElementById('warningCount').textContent = warningMahasiswas.length;
            
            if (warningMahasiswas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Tidak ada mahasiswa dalam early warning</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            warningMahasiswas.forEach((mhs, index) => {
                const row = document.createElement('tr');
                row.className = 'warning-row';
                
                const semester = getSemesterFromNIM(mhs.id);
                const thesisStatus = proposals.some(p => p.nim === mhs.id && p.status === 'Selesai') 
                    ? 'Selesai' 
                    : 'Belum Selesai';
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${mhs.id}</td>
                    <td>${mhs.name}</td>
                    <td>${mhs.prodi}</td>
                    <td>${semester}</td>
                    <td>${thesisStatus}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn" style="background: #f59e0b; color: white;" onclick="showMahasiswaDetail('${mhs.id}')">
                                <i class="fas fa-eye"></i> Detail
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function showMahasiswaDetail(nim) {
            const mahasiswa = users.find(u => u.id === nim && u.role === 'mahasiswa');
            if (!mahasiswa) {
                showToast('Data mahasiswa tidak ditemukan!', 'error');
                return;
            }
            
            const mhsProposals = proposals.filter(p => p.nim === nim);
            
            let detailText = `Detail Mahasiswa:\n\n`;
            detailText += `NIM: ${mahasiswa.id}\n`;
            detailText += `Nama: ${mahasiswa.name}\n`;
            detailText += `Program Studi: ${mahasiswa.prodi}\n`;
            detailText += `Email: ${mahasiswa.email}\n`;
            detailText += `WhatsApp: ${mahasiswa.whatsapp}\n`;
            detailText += `Semester: ${getSemesterFromNIM(mahasiswa.id)}\n\n`;
            
            if (mhsProposals.length > 0) {
                detailText += `Proposal:\n`;
                mhsProposals.forEach((p, idx) => {
                    detailText += `\n${idx + 1}. ${p.judul}\n`;
                    detailText += `   Status: ${p.status}\n`;
                    detailText += `   Pembimbing: ${p.pembimbing1}${p.pembimbing2 ? ', ' + p.pembimbing2 : ''}\n`;
                    detailText += `   Tanggal: ${new Date(p.tanggal).toLocaleDateString('id-ID')}\n`;
                });
            } else {
                detailText += `Belum ada proposal yang diajukan.`;
            }
            
            alert(detailText);
        }

        // ========================================
        // REPOSITORY FUNCTIONS (ADMIN)
        // ========================================
        function showTambahRepositoryModal() {
            if (!currentUser || currentUser.role !== 'admin') {
                showToast('Hanya admin yang dapat menambah repository!', 'error');
                return;
            }
            
            document.getElementById('repoJudul').value = '';
            document.getElementById('repoPenulis').value = '';
            document.getElementById('repoTahun').value = new Date().getFullYear();
            document.getElementById('repoProdi').value = '';
            document.getElementById('repoAbstrak').value = '';
            document.getElementById('repoGoogleDrive').value = '';
            
            document.getElementById('tambahRepositoryModal').classList.add('active');
        }

        function saveRepository() {
            const judul = document.getElementById('repoJudul').value.trim();
            const penulis = document.getElementById('repoPenulis').value.trim();
            const tahun = document.getElementById('repoTahun').value.trim();
            const prodi = document.getElementById('repoProdi').value;
            const abstrak = document.getElementById('repoAbstrak').value.trim();
            const googleDriveUrl = document.getElementById('repoGoogleDrive').value.trim();
            
            if (!judul || !penulis || !tahun || !prodi || !abstrak || !googleDriveUrl) {
                showToast('Semua field harus diisi!', 'error');
                return;
            }
            
            if (!googleDriveUrl.includes('drive.google.com')) {
                showToast('URL harus berasal dari Google Drive!', 'error');
                return;
            }
            
            const newRepository = {
                id: 'REPO' + Date.now(),
                judul: judul,
                penulis: penulis,
                tahun: tahun,
                prodi: prodi,
                abstrak: abstrak,
                googleDriveUrl: googleDriveUrl,
                tanggal: new Date().toISOString()
            };
            
            repositories.push(newRepository);
            
            saveRepositoryDataToGitHub();
            
            closeModal('tambahRepositoryModal');
            showToast('Repository berhasil ditambahkan!', 'success');
        }

        function saveRepositoryDataToGitHub() {
            addToSaveQueue(async () => {
                await saveUserDataToGitHub('repositories.json', JSON.stringify(repositories));
                await loadRepositoryData(true);
            });
        }

        function displayRepositoryData() {
            const tbody = document.getElementById('repositoryTableBody');
            
            if (!currentUser) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Silakan login untuk melihat data</td></tr>';
                return;
            }
            
            const btnTambahRepo = document.getElementById('btnTambahRepository');
            if (btnTambahRepo) {
                btnTambahRepo.style.display = currentUser.role === 'admin' ? 'inline-flex' : 'none';
            }
            
            if (repositories.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-database"></i>
                            <p>Belum ada repository skripsi</p>
                            ${currentUser.role === 'admin' ? '<p><button class="btn btn-primary btn-sm" onclick="showTambahRepositoryModal()"><i class="fas fa-plus"></i> Tambah Repository</button></p>' : ''}
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            repositories.forEach((repo, index) => {
                const row = document.createElement('tr');
                
                // For admin, show edit and delete buttons
                let actions = `
                    <div class="repository-actions">
                        <button class="btn-view" onclick="viewAbstract('${repo.id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn-upload" onclick="viewGoogleDrive('${repo.id}')">
                            <i class="fas fa-file-pdf"></i> Upload File
                        </button>
                `;
                
                if (currentUser.role === 'admin') {
                    actions += `
                        <button class="btn-edit" onclick="editRepository('${repo.id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn-delete" onclick="deleteRepository('${repo.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                }
                
                actions += `</div>`;
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${repo.judul}</td>
                    <td>${repo.penulis}</td>
                    <td>${repo.tahun}</td>
                    <td>${repo.prodi}</td>
                    <td>${actions}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function editRepository(id) {
            if (!currentUser || currentUser.role !== 'admin') {
                showToast('Hanya admin yang dapat mengedit repository!', 'error');
                return;
            }
            
            const repo = repositories.find(r => r.id === id);
            if (!repo) {
                showToast('Repository tidak ditemukan!', 'error');
                return;
            }
            
            currentRepositoryId = id;
            document.getElementById('editRepoJudul').value = repo.judul;
            document.getElementById('editRepoPenulis').value = repo.penulis;
            document.getElementById('editRepoTahun').value = repo.tahun;
            document.getElementById('editRepoProdi').value = repo.prodi;
            document.getElementById('editRepoAbstrak').value = repo.abstrak;
            document.getElementById('editRepoGoogleDrive').value = repo.googleDriveUrl;
            
            document.getElementById('editRepositoryModal').classList.add('active');
        }

        function updateRepository() {
            const judul = document.getElementById('editRepoJudul').value.trim();
            const penulis = document.getElementById('editRepoPenulis').value.trim();
            const tahun = document.getElementById('editRepoTahun').value.trim();
            const prodi = document.getElementById('editRepoProdi').value;
            const abstrak = document.getElementById('editRepoAbstrak').value.trim();
            const googleDriveUrl = document.getElementById('editRepoGoogleDrive').value.trim();
            
            if (!judul || !penulis || !tahun || !prodi || !abstrak || !googleDriveUrl) {
                showToast('Semua field harus diisi!', 'error');
                return;
            }
            
            if (!googleDriveUrl.includes('drive.google.com')) {
                showToast('URL harus berasal dari Google Drive!', 'error');
                return;
            }
            
            const repoIndex = repositories.findIndex(r => r.id === currentRepositoryId);
            if (repoIndex === -1) {
                showToast('Repository tidak ditemukan!', 'error');
                return;
            }
            
            repositories[repoIndex] = {
                ...repositories[repoIndex],
                judul: judul,
                penulis: penulis,
                tahun: tahun,
                prodi: prodi,
                abstrak: abstrak,
                googleDriveUrl: googleDriveUrl
            };
            
            saveRepositoryDataToGitHub();
            
            closeModal('editRepositoryModal');
            showToast('Repository berhasil diupdate!', 'success');
        }

        function deleteRepository(id) {
            if (!currentUser || currentUser.role !== 'admin') {
                showToast('Hanya admin yang dapat menghapus repository!', 'error');
                return;
            }
            
            if (confirm('Apakah Anda yakin ingin menghapus repository ini?')) {
                repositories = repositories.filter(r => r.id !== id);
                
                saveRepositoryDataToGitHub();
                
                showToast('Repository berhasil dihapus!', 'success');
            }
        }

        function viewAbstract(repoId) {
            const repo = repositories.find(r => r.id === repoId);
            if (!repo) {
                showToast('Repository tidak ditemukan!', 'error');
                return;
            }
            
            document.getElementById('abstractTitle').textContent = repo.judul;
            document.getElementById('abstractContent').textContent = repo.abstrak;
            
            document.getElementById('viewAbstractModal').classList.add('active');
        }

        function viewGoogleDrive(repoId) {
            const repo = repositories.find(r => r.id === repoId);
            if (!repo) {
                showToast('Repository tidak ditemukan!', 'error');
                return;
            }
            
            let embedUrl = repo.googleDriveUrl;
            if (repo.googleDriveUrl.includes('drive.google.com/file/d/')) {
                const fileId = repo.googleDriveUrl.split('/d/')[1].split('/')[0];
                embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
            } else if (repo.googleDriveUrl.includes('drive.google.com/open?id=')) {
                const fileId = repo.googleDriveUrl.split('id=')[1];
                embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
            }
            
            document.getElementById('googleDriveFrame').src = embedUrl;
            document.getElementById('viewGoogleDriveModal').classList.add('active');
        }

        // ========================================
        // OPTIMIZED VALIDASI PROPOSAL
        // ========================================
        function validateProposal() {
            const status = document.getElementById('validasiStatus').value;
            const komentar = document.getElementById('validasiKomentar').value;
            
            if (!komentar) {
                showToast('Komentar harus diisi!', 'error');
                return;
            }
            
            const proposal = proposals.find(p => p.id === currentProposalId);
            if (!proposal) {
                showToast('Proposal tidak ditemukan!', 'error');
                return;
            }
            
            proposal.status = status;
            proposal.validasiKomentar = komentar;
            proposal.validatedAt = new Date().toISOString();
            proposal.validatedBy = currentUser.name;
            
            proposal.history.push({
                action: `Validasi: ${status}`,
                date: new Date().toISOString(),
                by: currentUser.name,
                role: currentUser.role,
                comment: komentar
            });
            
            const submitBtn = document.getElementById('btnValidasiProposal');
            submitBtn.classList.add('loading');
            submitBtn.disabled = true;
            
            saveProposalDataToGitHub();
            
            setTimeout(() => {
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
                
                closeModal('validasiModal');
                showToast(`Proposal ${status.toLowerCase()}!`, 'success');
            }, 300);
        }

        // ========================================
        // OPTIMIZED KIRIM BIMBINGAN
        // ========================================
        function submitBimbingan() {
            const bab = document.getElementById('bimbinganBab').value;
            const komentar = document.getElementById('bimbinganKomentar').value;
            const status = document.getElementById('bimbinganStatus').value;
            
            if (!bab || !komentar) {
                showToast('Bab dan Komentar harus diisi!', 'error');
                return;
            }
            
            const proposal = proposals.find(p => p.id === currentProposalId);
            if (!proposal) {
                showToast('Proposal tidak ditemukan!', 'error');
                return;
            }
            
            const newBimbingan = {
                id: 'BIMBING' + Date.now(),
                proposalId: currentProposalId,
                nim: proposal.nim,
                nama: proposal.nama,
                judul: proposal.judul,
                pembimbing1: proposal.pembimbing1,
                pembimbing2: proposal.pembimbing2,
                bab: bab,
                komentar: komentar,
                status: status,
                tanggal: new Date().toISOString(),
                dosen: currentUser.name,
                role: currentUser.role
            };
            
            bimbingans.push(newBimbingan);
            
            if (status === 'Selesai') {
                proposal.status = 'Selesai';
            } else if (status === 'Diterima') {
                proposal.status = 'Diterima';
            }
            
            const submitBtn = document.getElementById('btnKirimBimbingan');
            submitBtn.classList.add('loading');
            submitBtn.disabled = true;
            
            saveBimbinganDataToGitHub();
            saveProposalDataToGitHub();
            
            setTimeout(() => {
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
                
                closeModal('bimbinganModal');
                showToast('Bimbingan berhasil dikirim!', 'success');
            }, 300);
        }

        // ========================================
        // CRITICAL FIX: DISPLAY FUNCTIONS FOR ADMIN
        // ========================================
        function displayProposalData() {
            const tbody = document.getElementById('proposalTableBody');
            
            const adminControls = document.getElementById('adminProposalControls');
            if (adminControls) {
                adminControls.style.display = (currentUser && currentUser.role === 'admin') ? 'block' : 'none';
            }
            
            if (!currentUser) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">Silakan login untuk melihat data</td></tr>';
                return;
            }
            
            let filteredProposals = proposals;
            
            if (currentUser.role === 'mahasiswa') {
                filteredProposals = proposals.filter(p => p.nim === currentUser.id);
            } else if (currentUser.role === 'dosen') {
                filteredProposals = proposals.filter(p => 
                    p.pembimbing1 === currentUser.name || p.pembimbing2 === currentUser.name
                );
            }
            
            if (filteredProposals.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>${currentUser.role === 'mahasiswa' ? 'Anda belum mengajukan proposal' : 'Belum ada proposal'}</p>
                            ${currentUser.role === 'mahasiswa' ? '<p><button class="btn btn-primary btn-sm" onclick="showPengajuanForm()"><i class="fas fa-plus"></i> Ajukan Proposal</button></p>' : ''}
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            filteredProposals.forEach((proposal, index) => {
                const row = document.createElement('tr');
                
                let statusBadge = '';
                if (proposal.status === 'Diterima') {
                    statusBadge = '<span class="badge badge-success">Diterima</span>';
                } else if (proposal.status === 'Diperbaiki') {
                    statusBadge = '<span class="badge badge-warning">Diperbaiki</span>';
                } else if (proposal.status === 'Ditolak') {
                    statusBadge = '<span class="badge badge-danger">Ditolak</span>';
                } else {
                    statusBadge = '<span class="badge badge-info">Menunggu</span>';
                }
                
                let actions = '';
                if (currentUser.role === 'admin') {
                    actions = `
                        <div class="action-buttons">
                            <button class="action-btn" style="background: #2563eb; color: white;" onclick="showValidasiForm('${proposal.id}')">
                                <i class="fas fa-check"></i> Validasi
                            </button>
                            <button class="action-btn" style="background: #6b7280; color: white;" onclick="editProposal('${proposal.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn" style="background: #ef4444; color: white;" onclick="deleteProposal('${proposal.id}')">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </div>
                    `;
                } else if (currentUser.role === 'mahasiswa' && proposal.status === 'Menunggu Validasi') {
                    actions = `
                        <div class="action-buttons">
                            <button class="action-btn" style="background: #6b7280; color: white;" onclick="editProposal('${proposal.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn" style="background: #ef4444; color: white;" onclick="deleteProposal('${proposal.id}')">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </div>
                    `;
                } else if ((currentUser.role === 'dosen' || currentUser.role === 'mahasiswa') && 
                          (proposal.status === 'Diterima' || proposal.status === 'Diperbaiki')) {
                    if (currentUser.role === 'dosen') {
                        actions = `
                            <div class="action-buttons">
                                <button class="action-btn" style="background: #10b981; color: white;" onclick="showBimbinganForm('${proposal.id}')">
                                    <i class="fas fa-chalkboard-teacher"></i> Bimbingan
                                </button>
                                <button class="action-btn" style="background: #3b82f6; color: white;" onclick="downloadProposal('${proposal.id}')">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                        `;
                    } else {
                        actions = `
                            <div class="action-buttons">
                                <button class="action-btn" style="background: #10b981; color: white;" onclick="viewBimbinganHistory('${proposal.id}')">
                                    <i class="fas fa-history"></i> Riwayat Bimbingan
                                </button>
                                <button class="action-btn" style="background: #3b82f6; color: white;" onclick="downloadProposal('${proposal.id}')">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                        `;
                    }
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${proposal.nim}</td>
                    <td>${proposal.nama}</td>
                    <td>${proposal.judul}</td>
                    <td>${proposal.pembimbing1}</td>
                    <td>${proposal.pembimbing2 || '-'}</td>
                    <td>${proposal.similarity}%</td>
                    <td>${statusBadge}</td>
                    <td>${new Date(proposal.tanggal).toLocaleDateString('id-ID')}</td>
                    <td>${actions}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function displayBimbinganData() {
            const tbody = document.getElementById('bimbinganTableBody');
            
            const adminControls = document.getElementById('adminBimbinganControls');
            if (adminControls) {
                adminControls.style.display = (currentUser && currentUser.role === 'admin') ? 'block' : 'none';
            }
            
            if (!currentUser) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">Silakan login untuk melihat data</td></tr>';
                return;
            }
            
            let filteredBimbingans = bimbingans;
            
            if (currentUser.role === 'mahasiswa') {
                filteredBimbingans = bimbingans.filter(b => b.nim === currentUser.id);
            } else if (currentUser.role === 'dosen') {
                filteredBimbingans = bimbingans.filter(b => b.dosen === currentUser.name);
            }
            
            if (filteredBimbingans.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="empty-state">
                            <i class="fas fa-clipboard-list"></i>
                            <p>Belum ada data bimbingan</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const totalBimbingans = filteredBimbingans.length;
            const completedBimbingans = filteredBimbingans.filter(b => b.status === 'Selesai').length;
            const progress = totalBimbingans > 0 ? Math.round((completedBimbingans / totalBimbingans) * 100) : 0;
            
            document.getElementById('progressPercentage').textContent = `${progress}%`;
            document.getElementById('progressFill').style.width = `${progress}%`;
            
            tbody.innerHTML = '';
            filteredBimbingans.forEach((bimbingan, index) => {
                const row = document.createElement('tr');
                
                let statusBadge = '';
                if (bimbingan.status === 'Selesai') {
                    statusBadge = '<span class="badge badge-success">Selesai</span>';
                } else if (bimbingan.status === 'Diterima') {
                    statusBadge = '<span class="badge badge-success">Diterima</span>';
                } else {
                    statusBadge = '<span class="badge badge-warning">Perlu Revisi</span>';
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${bimbingan.nim}</td>
                    <td>${bimbingan.nama}</td>
                    <td>${bimbingan.judul}</td>
                    <td>${bimbingan.pembimbing1}</td>
                    <td>${bimbingan.pembimbing2 || '-'}</td>
                    <td>${bimbingan.bab}</td>
                    <td>${statusBadge}</td>
                    <td>${new Date(bimbingan.tanggal).toLocaleDateString('id-ID')}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn" style="background: #3b82f6; color: white;" onclick="viewBimbinganDetail('${bimbingan.id}')">
                                <i class="fas fa-eye"></i> Detail
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function displayMahasiswaData() {
            const tbody = document.getElementById('mahasiswaTableBody');
            
            if (!currentUser || currentUser.role !== 'admin') {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Akses ditolak. Hanya admin yang dapat melihat data ini.</td></tr>';
                return;
            }
            
            const mahasiswas = users.filter(u => u.role === 'mahasiswa');
            
            if (mahasiswas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <i class="fas fa-user-graduate"></i>
                            <p>Belum ada data mahasiswa</p>
                            <p><button class="btn btn-primary btn-sm" onclick="showTambahMahasiswaModal()"><i class="fas fa-plus"></i> Tambah Mahasiswa</button></p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            mahasiswas.forEach((mhs, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${mhs.id}</td>
                    <td>${mhs.name}</td>
                    <td>${mhs.email}</td>
                    <td>${mhs.whatsapp}</td>
                    <td>${mhs.prodi}</td>
                    <td>${new Date(mhs.createdAt).toLocaleDateString('id-ID')}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn" style="background: #6b7280; color: white;" onclick="showEditMahasiswaForm('${mhs.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn" style="background: #ef4444; color: white;" onclick="deleteMahasiswa('${mhs.id}')">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function displayDosenData() {
            const tbody = document.getElementById('dosenTableBody');
            
            if (!currentUser || currentUser.role !== 'admin') {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Akses ditolak. Hanya admin yang dapat melihat data ini.</td></tr>';
                return;
            }
            
            const dosens = users.filter(u => u.role === 'dosen');
            
            if (dosens.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <p>Belum ada data dosen</p>
                            <p><button class="btn btn-primary btn-sm" onclick="showTambahDosenModal()"><i class="fas fa-plus"></i> Tambah Dosen</button></p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            dosens.forEach((dosen, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${dosen.id}</td>
                    <td>${dosen.name}</td>
                    <td>${dosen.email}</td>
                    <td>${dosen.whatsapp}</td>
                    <td>${new Date(dosen.createdAt).toLocaleDateString('id-ID')}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn" style="background: #6b7280; color: white;" onclick="showEditDosenForm('${dosen.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn" style="background: #ef4444; color: white;" onclick="deleteDosen('${dosen.id}')">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // ========================================
        // LOAD FUNCTIONS - DENGAN CACHE
        // ========================================
        let dataCache = {
            users: null,
            proposals: null,
            bimbingans: null,
            repositories: null,
            lastUpdated: null
        };

        async function loadUserData(forceRefresh = false) {
            try {
                if (!forceRefresh && dataCache.users && 
                    Date.now() - dataCache.lastUpdated < 5000) {
                    users = dataCache.users;
                    loadDosenToDropdown();
                    displayMahasiswaData();
                    displayDosenData();
                    displayWarningData();
                    return;
                }
                
                showLoading('Memuat data user...');
                
                const response = await fetch(`${GITHUB_API_URL}/users.json?timestamp=${Date.now()}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const content = decodeURIComponent(escape(atob(data.content)));
                    users = JSON.parse(content);
                    
                    dataCache.users = users;
                    dataCache.lastUpdated = Date.now();
                } else {
                    users = [];
                }
                
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                }
                
                loadDosenToDropdown();
                displayMahasiswaData();
                displayDosenData();
                displayWarningData();
                hideLoading();
                
            } catch (error) {
                showToast('Gagal memuat data user!', 'error');
                users = [];
                loadDosenToDropdown();
                displayMahasiswaData();
                displayDosenData();
                displayWarningData();
            }
        }

        async function loadProposalData(forceRefresh = false) {
            try {
                if (!forceRefresh && dataCache.proposals && 
                    Date.now() - dataCache.lastUpdated < 5000) {
                    proposals = dataCache.proposals;
                    displayProposalData();
                    return;
                }
                
                showLoading('Memuat data proposal...');
                
                const response = await fetch(`${GITHUB_API_URL}/proposals.json?timestamp=${Date.now()}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const content = decodeURIComponent(escape(atob(data.content)));
                    proposals = JSON.parse(content);
                    
                    dataCache.proposals = proposals;
                    dataCache.lastUpdated = Date.now();
                } else {
                    proposals = [];
                }
                
                displayProposalData();
                hideLoading();
                updateStats();
                
            } catch (error) {
                showToast('Gagal memuat data proposal!', 'error');
                proposals = [];
                displayProposalData();
            }
        }

        async function loadBimbinganData(forceRefresh = false) {
            try {
                if (!forceRefresh && dataCache.bimbingans && 
                    Date.now() - dataCache.lastUpdated < 5000) {
                    bimbingans = dataCache.bimbingans;
                    displayBimbinganData();
                    return;
                }
                
                showLoading('Memuat data bimbingan...');
                
                const response = await fetch(`${GITHUB_API_URL}/bimbingans.json?timestamp=${Date.now()}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const content = decodeURIComponent(escape(atob(data.content)));
                    bimbingans = JSON.parse(content);
                    
                    dataCache.bimbingans = bimbingans;
                    dataCache.lastUpdated = Date.now();
                } else {
                    bimbingans = [];
                }
                
                displayBimbinganData();
                hideLoading();
                
            } catch (error) {
                showToast('Gagal memuat data bimbingan!', 'error');
                bimbingans = [];
                displayBimbinganData();
            }
        }

        async function loadRepositoryData(forceRefresh = false) {
            try {
                if (!forceRefresh && dataCache.repositories && 
                    Date.now() - dataCache.lastUpdated < 5000) {
                    repositories = dataCache.repositories;
                    displayRepositoryData();
                    return;
                }
                
                showLoading('Memuat data repository...');
                
                const response = await fetch(`${GITHUB_API_URL}/repositories.json?timestamp=${Date.now()}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const content = decodeURIComponent(escape(atob(data.content)));
                    repositories = JSON.parse(content);
                    
                    dataCache.repositories = repositories;
                    dataCache.lastUpdated = Date.now();
                } else {
                    repositories = [];
                }
                
                displayRepositoryData();
                hideLoading();
                
            } catch (error) {
                showToast('Gagal memuat data repository!', 'error');
                repositories = [];
                displayRepositoryData();
            }
        }

        // ========================================
        // SAVE FUNCTIONS
        // ========================================
        async function saveProposalDataToGitHub() {
            try {
                await addToSaveQueue(async () => {
                    await saveUserDataToGitHub('proposals.json', JSON.stringify(proposals));
                    await loadProposalData(true);
                });
            } catch (error) {
                console.error('Error in saveProposalDataToGitHub:', error);
            }
        }

        async function saveBimbinganDataToGitHub() {
            try {
                await addToSaveQueue(async () => {
                    await saveUserDataToGitHub('bimbingans.json', JSON.stringify(bimbingans));
                    await loadBimbinganData(true);
                });
            } catch (error) {
                console.error('Error in saveBimbinganDataToGitHub:', error);
            }
        }

        async function saveUserDataToGitHub(filename, content, retryCount = 1) {
            try {
                showLoading(`Menyimpan ${filename}...`);
                
                const sha = await getFileSha(filename);
                
                const data = {
                    message: `Update ${filename} - ${new Date().toISOString()}`,
                    content: btoa(unescape(encodeURIComponent(content))),
                    ...(sha && { sha })
                };
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(`${GITHUB_API_URL}/${filename}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(data),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    if (response.status === 403) {
                        throw new Error('Rate limit exceeded. Silakan tunggu beberapa saat.');
                    }
                    if (response.status === 409 && retryCount > 0) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        return await saveUserDataToGitHub(filename, content, retryCount - 1);
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                hideLoading();
                showToast(`Berhasil menyimpan ${filename}!`, 'success');
                return result;
                
            } catch (error) {
                if (retryCount > 0) {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    return await saveUserDataToGitHub(filename, content, retryCount - 1);
                }
                
                hideLoading();
                showToast(`Gagal menyimpan ${filename}: ${error.message}`, 'error');
                throw error;
            }
        }

        async function getFileSha(filename) {
            try {
                const response = await fetch(`${GITHUB_API_URL}/${filename}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.sha;
                }
                return null;
            } catch (error) {
                return null;
            }
        }

        // ========================================
        // QUEUE SYSTEM
        // ========================================
        let isSaving = false;
        let saveQueue = [];

        async function addToSaveQueue(operation, timeout = 15000) {
            return new Promise((resolve, reject) => {
                const operationId = Date.now();
                
                const timer = setTimeout(() => {
                    reject(new Error('Operation timeout'));
                }, timeout);
                
                saveQueue.push({ 
                    operation, 
                    resolve, 
                    reject,
                    timer,
                    id: operationId
                });
                
                processSaveQueue();
            });
        }

        async function processSaveQueue() {
            if (isSaving || saveQueue.length === 0) return;
            
            isSaving = true;
            const { operation, resolve, reject, timer, id } = saveQueue.shift();
            
            try {
                await operation();
                clearTimeout(timer);
                resolve();
            } catch (error) {
                clearTimeout(timer);
                reject(error);
            } finally {
                isSaving = false;
                if (saveQueue.length > 0) {
                    setTimeout(processSaveQueue, 100);
                }
            }
        }

        // ========================================
        // HELPER FUNCTIONS
        // ========================================
        function showLoading(message = 'Memproses data...') {
            showToast(message, 'warning');
        }

        function hideLoading() {
            // Auto hide by toast timeout
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toastNotification');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = toast.querySelector('i');
            
            toastMessage.textContent = message;
            
            toast.className = 'toast';
            
            if (type === 'success') {
                toast.classList.add('toast-success');
                toastIcon.className = 'fas fa-check-circle';
            } else if (type === 'error') {
                toast.classList.add('toast-error');
                toastIcon.className = 'fas fa-exclamation-circle';
            } else if (type === 'warning') {
                toast.classList.add('toast-warning');
                toastIcon.className = 'fas fa-exclamation-triangle';
            }
            
            toast.classList.add('active');
            
            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            
            // Reset validation errors
            document.querySelectorAll('.validation-error').forEach(el => {
                el.classList.remove('show');
                el.textContent = '';
            });
            
            // Reset submitting state
            isSubmitting = false;
            isEditingProposal = false;
            currentEditProposalId = null;
            
            // Reset button states
            const submitBtn = document.getElementById('btnSubmitProposal');
            const validasiBtn = document.getElementById('btnValidasiProposal');
            const bimbinganBtn = document.getElementById('btnKirimBimbingan');
            
            if (submitBtn) {
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
                document.getElementById('modalTitle').textContent = 'Form Pengajuan Proposal';
                document.getElementById('submitButtonText').textContent = 'Ajukan Proposal';
                document.getElementById('editModeIndicator').style.display = 'none';
            }
            
            if (validasiBtn) {
                validasiBtn.classList.remove('loading');
                validasiBtn.disabled = false;
            }
            
            if (bimbinganBtn) {
                bimbinganBtn.classList.remove('loading');
                bimbinganBtn.disabled = false;
            }
            
            // Reset detail modals
            if (modalId === 'detailBimbinganModal' || modalId === 'riwayatBimbinganModal' || 
                modalId === 'viewAbstractModal' || modalId === 'viewGoogleDriveModal' ||
                modalId === 'editRepositoryModal') {
                document.getElementById('detailHistoryList').innerHTML = '';
                document.getElementById('riwayatHistoryList').innerHTML = '';
                document.getElementById('googleDriveFrame').src = 'about:blank';
                document.getElementById('editRepositoryId').value = '';
            }
        }

        // ========================================
        // DOM READY
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Load all data
            loadUserData();
            loadProposalData();
            loadBimbinganData();
            loadRepositoryData();
            
            updateUserInterface();
            
            // Setup event listener for submit button
            const submitBtn = document.getElementById('btnSubmitProposal');
            if (submitBtn) {
                submitBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    submitProposal();
                });
            }
        });

        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('currentTime').textContent = now.toLocaleDateString('id-ID', options);
        }

        function updateUserInterface() {
            const userSection = document.getElementById('userSection');
            const userName = document.getElementById('userName');
            const userRole = document.getElementById('userRole');
            const userAvatar = document.getElementById('userAvatar');
            const sidebar = document.querySelector('.sidebar');
            
            if (currentUser) {
                userName.textContent = currentUser.name;
                userRole.textContent = currentUser.role === 'admin' ? 'Administrator' : 
                                      (currentUser.role === 'mahasiswa' ? 'Mahasiswa' : 'Dosen');
                userAvatar.textContent = currentUser.name.charAt(0);
                userSection.querySelector('.btn-primary').style.display = 'none';
                
                const menuItems = sidebar.querySelectorAll('a');
                menuItems.forEach(item => {
                    const href = item.getAttribute('onclick');
                    if (currentUser.role === 'mahasiswa') {
                        if (href.includes('early-warning') || href.includes('repository')) {
                            item.style.display = 'none';
                        } else {
                            item.style.display = 'flex';
                        }
                    } else if (currentUser.role === 'dosen') {
                        if (href.includes('pengajuan') && !href.includes('showSection')) {
                            item.style.display = 'none';
                        } else {
                            item.style.display = 'flex';
                        }
                    } else {
                        item.style.display = 'flex';
                    }
                });
                
                if (currentUser.role === 'admin') {
                    document.getElementById('menuDataMahasiswa').style.display = 'flex';
                    document.getElementById('menuDataDosen').style.display = 'flex';
                } else {
                    document.getElementById('menuDataMahasiswa').style.display = 'none';
                    document.getElementById('menuDataDosen').style.display = 'none';
                }
            } else {
                userName.textContent = 'Guest';
                userRole.textContent = 'Belum Login';
                userAvatar.textContent = 'G';
                userSection.querySelector('.btn-primary').style.display = 'block';
                
                const menuItems = sidebar.querySelectorAll('a');
                menuItems.forEach(item => {
                    const href = item.getAttribute('onclick');
                    if (href.includes('dashboard')) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                document.getElementById('menuDataMahasiswa').style.display = 'none';
                document.getElementById('menuDataDosen').style.display = 'none';
            }
            
            updateButtonVisibility();
        }

        function updateButtonVisibility() {
            const isMahasiswa = currentUser && currentUser.role === 'mahasiswa';
            const isAdmin = currentUser && currentUser.role === 'admin';
            
            const btnAjukanProposal = document.getElementById('btnAjukanProposal');
            const btnExportProposal = document.getElementById('btnExportProposal');
            const btnPrintProposal = document.getElementById('btnPrintProposal');
            
            if (btnAjukanProposal) {
                btnAjukanProposal.style.display = isMahasiswa ? 'inline-flex' : 'none';
            }
            
            if (btnExportProposal) {
                btnExportProposal.style.display = isAdmin ? 'inline-flex' : 'none';
            }
            
            if (btnPrintProposal) {
                btnPrintProposal.style.display = isAdmin ? 'inline-flex' : 'none';
            }
        }

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.top-menu a, .sidebar-menu a').forEach(link => {
                link.classList.remove('active');
            });
            
            if (sectionId === 'dashboard') {
                updateStats();
            } else if (sectionId === 'early-warning') {
                displayWarningData();
            } else if (sectionId === 'repository') {
                displayRepositoryData();
            } else if (sectionId === 'pengajuan') {
                displayProposalData();
            } else if (sectionId === 'bimbingan') {
                displayBimbinganData();
            } else if (sectionId === 'data-mahasiswa') {
                displayMahasiswaData();
            } else if (sectionId === 'data-dosen') {
                displayDosenData();
            }
        }

        function updateStats() {
            document.getElementById('proposalCount').textContent = proposals.length;
            document.getElementById('bimbinganCount').textContent = bimbingans.length;
            document.getElementById('selesaiCount').textContent = proposals.filter(p => p.status === 'Selesai').length;
            document.getElementById('warningCount').textContent = '0';
            document.getElementById('repositoryCount').textContent = repositories.length;
            
            displayWarningData();
        }

        // ========================================
        // LOGIN FUNCTION - CRITICAL FIX
        // ========================================
        function login() {
            const id = document.getElementById('loginId').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!id || !password) {
                showToast('Semua field harus diisi!', 'error');
                return;
            }

            if (id === 'admin' && password === 'admin123') {
                currentUser = {
                    id: 'admin',
                    name: 'Administrator',
                    role: 'admin',
                    email: 'admin@febi.uinsi.ac.id',
                    whatsapp: '-',
                    prodi: '-'
                };
                saveUserData();
                updateUserInterface();
                
                forceRefresh();
                
                closeModal('loginModal');
                showToast('Login berhasil sebagai Admin!', 'success');
                return;
            }

            const user = users.find(u => u.id === id && u.password === password);
            
            if (user) {
                currentUser = user;
                saveUserData();
                updateUserInterface();
                
                forceRefresh();
                
                closeModal('loginModal');
                showToast(`Login berhasil sebagai ${user.role === 'mahasiswa' ? 'Mahasiswa' : 'Dosen'}!`, 'success');
            } else {
                showToast('ID atau Password salah!', 'error');
            }
        }

        function register() {
            const userType = document.getElementById('userType').value;
            const id = document.getElementById('registerId').value.trim();
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const whatsapp = document.getElementById('registerWhatsApp').value.trim();
            const prodi = document.getElementById('registerProdi').value;
            const password = document.getElementById('registerPassword').value.trim();
            const confirmPassword = document.getElementById('registerConfirmPassword').value.trim();

            if (!userType || !id || !name || !email || !whatsapp || !password || !confirmPassword) {
                showToast('Semua field harus diisi!', 'error');
                return;
            }

            if (userType === 'mahasiswa' && !prodi) {
                showToast('Program Studi harus dipilih untuk mahasiswa!', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showToast('Password dan konfirmasi password tidak sama!', 'error');
                return;
            }

            if (users.some(u => u.id === id)) {
                showToast('ID sudah terdaftar!', 'error');
                return;
            }

            const newUser = {
                id: id,
                name: name,
                email: email,
                whatsapp: whatsapp,
                prodi: userType === 'mahasiswa' ? prodi : '-',
                password: password,
                role: userType,
                createdAt: new Date().toISOString()
            };

            users.push(newUser);
            
            addToSaveQueue(async () => {
                await saveUserDataToGitHub('users.json', JSON.stringify(users));
                await loadUserData(true);
                
                showToast('Registrasi berhasil! Silakan login.', 'success');
                closeModal('registerModal');
                showLoginModal();
                
                if (userType === 'dosen') {
                    loadDosenToDropdown();
                }
                
                forceRefresh();
            }).catch(error => {
                console.error('Error in register:', error);
                showToast('Gagal menyimpan data registrasi!', 'error');
            });
        }

        function saveUserData() {
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
        }

        function logout() {
            currentUser = null;
            saveUserData();
            updateUserInterface();
            
            proposals = [];
            bimbingans = [];
            users = [];
            repositories = [];
            
            displayProposalData();
            displayBimbinganData();
            displayMahasiswaData();
            displayDosenData();
            displayRepositoryData();
            displayWarningData();
            
            showToast('Logout berhasil!', 'success');
        }

        function forceRefresh() {
            dataCache = { users: null, proposals: null, bimbingans: null, repositories: null, lastUpdated: null };
            loadUserData(true);
            loadProposalData(true);
            loadBimbinganData(true);
            loadRepositoryData(true);
            showToast('Data berhasil di-refresh!', 'success');
        }

        // ========================================
        // REMAINING FUNCTIONS
        // ========================================
        function submitProposal() {
            if (isSubmitting) {
                showToast('Tunggu proses sebelumnya selesai!', 'warning');
                return;
            }

            document.querySelectorAll('.validation-error').forEach(el => {
                el.classList.remove('show');
                el.textContent = '';
            });

            const judul = document.getElementById('judulProposal').value.trim();
            const pembimbing1 = document.getElementById('pembimbing1').value;
            const pembimbing2 = document.getElementById('pembimbing2').value;
            
            let hasError = false;

            if (!judul) {
                showError('errorJudul', 'Judul proposal harus diisi!');
                hasError = true;
            } else if (judul.length < 10) {
                showError('errorJudul', 'Judul terlalu pendek (minimal 10 karakter)!');
                hasError = true;
            }

            if (!pembimbing1) {
                showError('errorPembimbing1', 'Dosen Pembimbing 1 harus dipilih!');
                hasError = true;
            }

            if (!isEditingProposal && !uploadedFile) {
                showError('errorFile', 'File proposal harus diupload!');
                hasError = true;
            }

            const similarityResult = document.getElementById('similarityResult');
            if (similarityResult.style.display === 'none' && !isEditingProposal) {
                showError('errorJudul', 'Silakan tunggu hasil cek similarity!');
                hasError = true;
            }

            if (hasError) {
                showToast('Silakan perbaiki kesalahan di atas!', 'error');
                return;
            }

            let similarityPercentage = 0;
            if (!isEditingProposal) {
                similarityPercentage = parseInt(document.getElementById('similarityPercentage').textContent);
                if (similarityPercentage > 70) {
                    showToast('Judul terlalu mirip dengan proposal lain! Silakan ganti judul.', 'error');
                    return;
                }
            }

            isSubmitting = true;
            const submitBtn = document.getElementById('btnSubmitProposal');
            submitBtn.classList.add('loading');
            submitBtn.disabled = true;

            if (isEditingProposal && currentEditProposalId) {
                const proposalIndex = proposals.findIndex(p => p.id === currentEditProposalId);
                if (proposalIndex !== -1) {
                    proposals[proposalIndex].judul = judul;
                    proposals[proposalIndex].pembimbing1 = pembimbing1;
                    proposals[proposalIndex].pembimbing2 = pembimbing2 || '-';
                    proposals[proposalIndex].updatedAt = new Date().toISOString();
                    proposals[proposalIndex].updatedBy = currentUser.name;
                    
                    if (!proposals[proposalIndex].history) {
                        proposals[proposalIndex].history = [];
                    }
                    proposals[proposalIndex].history.push({
                        action: 'Edit Proposal',
                        date: new Date().toISOString(),
                        by: currentUser.name,
                        role: currentUser.role
                    });
                }
            } else {
                const newProposal = {
                    id: 'PROP' + Date.now(),
                    nim: currentUser.id,
                    nama: currentUser.name,
                    email: currentUser.email,
                    whatsapp: currentUser.whatsapp,
                    prodi: currentUser.prodi,
                    judul: judul,
                    pembimbing1: pembimbing1,
                    pembimbing2: pembimbing2 || '-',
                    similarity: similarityPercentage,
                    status: 'Menunggu Validasi',
                    tanggal: new Date().toISOString(),
                    file: uploadedFile ? uploadedFile.name : 'proposal.pdf',
                    history: [{
                        action: 'Diajukan',
                        date: new Date().toISOString(),
                        by: currentUser.name,
                        role: currentUser.role
                    }]
                };

                proposals.push(newProposal);
            }

            addToSaveQueue(async () => {
                await saveProposalDataToGitHub();
                
                uploadedFile = null;
                document.getElementById('fileInfo').style.display = 'none';
                document.getElementById('similarityResult').style.display = 'none';
                isEditingProposal = false;
                currentEditProposalId = null;
                
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
                isSubmitting = false;
                
                document.getElementById('modalTitle').textContent = 'Form Pengajuan Proposal';
                document.getElementById('submitButtonText').textContent = 'Ajukan Proposal';
                document.getElementById('editModeIndicator').style.display = 'none';
                
                closeModal('pengajuanModal');
                showToast(isEditingProposal ? 'Proposal berhasil diupdate!' : 'Proposal berhasil diajukan!', 'success');
                
            }).catch(error => {
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
                isSubmitting = false;
                
                showToast('Gagal menyimpan proposal. Silakan coba lagi.', 'error');
            });
        }

        function editProposal(id) {
            if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'mahasiswa')) {
                showToast('Anda tidak memiliki akses untuk mengedit proposal ini!', 'error');
                return;
            }
            
            const proposal = proposals.find(p => p.id === id);
            if (!proposal) {
                showToast('Proposal tidak ditemukan!', 'error');
                return;
            }
            
            if (currentUser.role === 'mahasiswa' && proposal.nim !== currentUser.id) {
                showToast('Anda hanya dapat mengedit proposal Anda sendiri!', 'error');
                return;
            }
            
            isEditingProposal = true;
            currentEditProposalId = id;
            
            document.getElementById('nim').value = proposal.nim;
            document.getElementById('namaLengkap').value = proposal.nama;
            document.getElementById('email').value = proposal.email;
            document.getElementById('whatsapp').value = proposal.whatsapp;
            document.getElementById('prodi').value = proposal.prodi;
            document.getElementById('judulProposal').value = proposal.judul;
            document.getElementById('pembimbing1').value = proposal.pembimbing1;
            document.getElementById('pembimbing2').value = proposal.pembimbing2 || '';
            
            document.getElementById('modalTitle').textContent = 'Edit Proposal';
            document.getElementById('submitButtonText').textContent = 'Update Proposal';
            document.getElementById('editModeIndicator').style.display = 'block';
            
            loadDosenToDropdown();
            document.getElementById('pengajuanModal').classList.add('active');
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.classList.add('show');
            }
        }

         function validatePembimbing() {
            const pembimbing1 = document.getElementById('pembimbing1').value;
            const pembimbing2 = document.getElementById('pembimbing2').value;
            
            if (pembimbing1 && pembimbing2 && pembimbing1 === pembimbing2) {
                showError('errorPembimbing1', 'Pembimbing 1 dan Pembimbing 2 tidak boleh sama!');
                document.getElementById('pembimbing2').value = '';
            } else {
                document.getElementById('errorPembimbing1').classList.remove('show');
                document.getElementById('errorPembimbing1').textContent = '';
            }
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showToast('File terlalu besar! Maksimal 5MB', 'error');
                    input.value = '';
                    return;
                }
                
                if (file.type !== 'application/pdf') {
                    showToast('Format file harus PDF!', 'error');
                    input.value = '';
                    return;
                }
                
                uploadedFile = file;
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileInfo').style.display = 'block';
                
                document.getElementById('errorFile').classList.remove('show');
                document.getElementById('errorFile').textContent = '';
                
                showToast('File berhasil diupload!', 'success');
            }
        }

        function removeFileUpload() {
            uploadedFile = null;
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('fileProposal').value = '';
        }

        function showBimbinganForm(proposalId) {
            if (!currentUser) {
                showToast('Anda harus login terlebih dahulu!', 'error');
                return;
            }
            
            const proposal = proposals.find(p => p.id === proposalId);
            if (!proposal) {
                showToast('Proposal tidak ditemukan!', 'error');
                return;
            }
            
            if (currentUser.role === 'dosen' && 
                currentUser.name !== proposal.pembimbing1 && 
                currentUser.name !== proposal.pembimbing2) {
                showToast('Anda bukan pembimbing proposal ini!', 'error');
                return;
            }
            
            currentProposalId = proposalId;
            document.getElementById('bimbinganBab').value = '';
            document.getElementById('bimbinganKomentar').value = '';
            document.getElementById('bimbinganStatus').value = 'Perlu Revisi';
            
            loadBimbinganHistory(proposalId);
            document.getElementById('bimbinganModal').classList.add('active');
        }

        function loadBimbinganHistory(proposalId) {
            const historyList = document.getElementById('historyList');
            const bimbinganHistory = document.getElementById('bimbinganHistory');
            
            const history = bimbingans.filter(b => b.proposalId === proposalId).sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
            
            if (history.length > 0) {
                bimbinganHistory.style.display = 'block';
                historyList.innerHTML = '';
                
                history.forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `
                        <div class="history-header">
                            <span>${item.bab} - ${item.status}</span>
                            <span>${new Date(item.tanggal).toLocaleDateString('id-ID')}</span>
                        </div>
                        <div class="history-content">
                            <strong>Dosen: ${item.dosen}</strong><br>
                            ${item.komentar}
                        </div>
                    `;
                    historyList.appendChild(historyItem);
                });
            } else {
                bimbinganHistory.style.display = 'none';
            }
        }

        function viewBimbinganDetail(id) {
            const bimbingan = bimbingans.find(b => b.id === id);
            if (!bimbingan) {
                showToast('Data bimbingan tidak ditemukan!', 'error');
                return;
            }
            
            document.getElementById('detailBab').textContent = bimbingan.bab;
            document.getElementById('detailKomentar').textContent = bimbingan.komentar;
            document.getElementById('detailStatus').textContent = bimbingan.status;
            document.getElementById('detailDosen').textContent = bimbingan.dosen;
            document.getElementById('detailTanggal').textContent = new Date(bimbingan.tanggal).toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            loadDetailBimbinganHistory(bimbingan.proposalId);
            document.getElementById('detailBimbinganModal').classList.add('active');
        }

        function loadDetailBimbinganHistory(proposalId) {
            const historyList = document.getElementById('detailHistoryList');
            const detailHistory = document.getElementById('detailHistory');
            
            const history = bimbingans.filter(b => b.proposalId === proposalId).sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
            
            if (history.length > 0) {
                detailHistory.style.display = 'block';
                historyList.innerHTML = '';
                
                history.forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `
                        <div class="history-header">
                            <span>${item.bab} - ${item.status}</span>
                            <span>${new Date(item.tanggal).toLocaleDateString('id-ID')}</span>
                        </div>
                        <div class="history-content">
                            <strong>Dosen: ${item.dosen}</strong><br>
                            ${item.komentar}
                        </div>
                    `;
                    historyList.appendChild(historyItem);
                });
            } else {
                detailHistory.style.display = 'none';
            }
        }

        function viewBimbinganHistory(proposalId) {
            document.querySelector('#riwayatBimbinganModal .modal-title').textContent = 'Riwayat Bimbingan Proposal';
            loadRiwayatBimbinganHistory(proposalId);
            document.getElementById('riwayatBimbinganModal').classList.add('active');
        }

        function loadRiwayatBimbinganHistory(proposalId) {
            const historyList = document.getElementById('riwayatHistoryList');
            
            const history = bimbingans.filter(b => b.proposalId === proposalId).sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
            
            if (history.length > 0) {
                historyList.innerHTML = '';
                
                history.forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `
                        <div class="history-header">
                            <span>${item.bab} - ${item.status}</span>
                            <span>${new Date(item.tanggal).toLocaleDateString('id-ID')}</span>
                        </div>
                        <div class="history-content">
                            <strong>Dosen: ${item.dosen}</strong><br>
                            ${item.komentar}
                        </div>
                    `;
                    historyList.appendChild(historyItem);
                });
            } else {
                historyList.innerHTML = '<p style="text-align: center; padding: 1rem; color: #6b7280;">Belum ada riwayat bimbingan untuk proposal ini.</p>';
            }
        }

        function downloadProposal(proposalId) {
            const proposal = proposals.find(p => p.id === proposalId);
            if (!proposal) {
                showToast('Proposal tidak ditemukan!', 'error');
                return;
            }
            
            const content = `
Proposal Skripsi
===============
Judul: ${proposal.judul}
NIM: ${proposal.nim}
Nama: ${proposal.nama}
Program Studi: ${proposal.prodi}
Pembimbing 1: ${proposal.pembimbing1}
Pembimbing 2: ${proposal.pembimbing2 || '-'}
Status: ${proposal.status}
Tanggal Pengajuan: ${new Date(proposal.tanggal).toLocaleDateString('id-ID')}
Similarity: ${proposal.similarity}%

${proposal.file ? `File: ${proposal.file}` : 'File tidak tersedia'}

Riwayat Proposal:
${proposal.history ? proposal.history.map(h => 
    `- [${new Date(h.date).toLocaleDateString('id-ID')}] ${h.action} oleh ${h.by} (${h.role})${h.comment ? ': ' + h.comment : ''}`
).join('\n') : 'Tidak ada riwayat'}

Catatan: File proposal asli tidak tersedia dalam sistem demo ini.
File ini adalah ringkasan proposal dalam format teks.
            `;
            
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `proposal_${proposal.nim}_${proposal.judul.substring(0, 30).replace(/\s+/g, '_')}.txt`;
            
            document.body.appendChild(a);
            a.click();
            
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showToast('File proposal berhasil diunduh!', 'success');
        }

        function showPengajuanForm() {
            if (!currentUser || currentUser.role !== 'mahasiswa') {
                showToast('Anda harus login sebagai mahasiswa untuk mengajukan proposal!', 'error');
                return;
            }
            
            document.getElementById('nim').value = currentUser.id;
            document.getElementById('namaLengkap').value = currentUser.name;
            document.getElementById('email').value = currentUser.email;
            document.getElementById('whatsapp').value = currentUser.whatsapp;
            document.getElementById('prodi').value = currentUser.prodi;
            
            document.getElementById('judulProposal').value = '';
            document.getElementById('pembimbing1').value = '';
            document.getElementById('pembimbing2').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('similarityResult').style.display = 'none';
            uploadedFile = null;
            isSubmitting = false;
            isEditingProposal = false;
            currentEditProposalId = null;
            
            const submitBtn = document.getElementById('btnSubmitProposal');
            if (submitBtn) {
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
                document.getElementById('modalTitle').textContent = 'Form Pengajuan Proposal';
                document.getElementById('submitButtonText').textContent = 'Ajukan Proposal';
                document.getElementById('editModeIndicator').style.display = 'none';
            }
            
            loadDosenToDropdown();
            document.getElementById('pengajuanModal').classList.add('active');
        }

        function loadDosenToDropdown() {
            const pembimbing1 = document.getElementById('pembimbing1');
            const pembimbing2 = document.getElementById('pembimbing2');
            
            const selectedPembimbing1 = pembimbing1.value;
            const selectedPembimbing2 = pembimbing2.value;
            
            pembimbing1.innerHTML = '<option value="">-- Pilih Dosen Pembimbing 1 --</option>';
            pembimbing2.innerHTML = '<option value="">-- Pilih Dosen Pembimbing 2 (Opsional) --</option>';
            
            const dosens = users.filter(user => user.role === 'dosen');
            
            dosens.forEach(dosen => {
                const option1 = document.createElement('option');
                option1.value = dosen.name;
                option1.textContent = dosen.name;
                pembimbing1.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = dosen.name;
                option2.textContent = dosen.name;
                pembimbing2.appendChild(option2);
            });
            
            if (selectedPembimbing1) {
                pembimbing1.value = selectedPembimbing1;
            }
            if (selectedPembimbing2) {
                pembimbing2.value = selectedPembimbing2;
            }
            
            if (dosens.length === 0) {
                pembimbing1.innerHTML = '<option value="">-- Belum ada dosen terdaftar --</option>';
                pembimbing2.innerHTML = '<option value="">-- Belum ada dosen terdaftar --</option>';
            }
        }

        function showLoginModal() {
            document.getElementById('loginModal').classList.add('active');
        }

        function showRegisterModal() {
            closeModal('loginModal');
            document.getElementById('registerModal').classList.add('active');
        }

        function toggleRegisterFields() {
            const userType = document.getElementById('userType').value;
            const prodiField = document.getElementById('prodiField');
            
            if (userType === 'dosen') {
                prodiField.style.display = 'none';
            } else {
                prodiField.style.display = 'block';
            }
        }

        function saveMahasiswaBaru() {
            const nim = document.getElementById('nimBaru').value.trim();
            const nama = document.getElementById('namaMahasiswaBaru').value.trim();
            const email = document.getElementById('emailMahasiswaBaru').value.trim();
            const whatsapp = document.getElementById('whatsappMahasiswaBaru').value.trim();
            const prodi = document.getElementById('prodiMahasiswaBaru').value;
            const password = document.getElementById('passwordMahasiswaBaru').value.trim();
            const confirmPassword = document.getElementById('confirmPasswordMahasiswaBaru').value.trim();

            if (!nim || !nama || !email || !whatsapp || !prodi || !password || !confirmPassword) {
                showToast('Semua field harus diisi!', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showToast('Password dan konfirmasi password tidak sama!', 'error');
                return;
            }

            if (users.some(u => u.id === nim)) {
                showToast('NIM sudah terdaftar!', 'error');
                return;
            }

            const newMahasiswa = {
                id: nim,
                name: nama,
                email: email,
                whatsapp: whatsapp,
                prodi: prodi,
                password: password,
                role: 'mahasiswa',
                createdAt: new Date().toISOString()
            };

            users.push(newMahasiswa);
            
            addToSaveQueue(async () => {
                await saveUserDataToGitHub('users.json', JSON.stringify(users));
                await loadUserData(true);
                
                closeModal('tambahMahasiswaModal');
                showToast('Data mahasiswa berhasil ditambahkan!', 'success');
            }).catch(error => {
                console.error('Error in saveMahasiswaBaru:', error);
                showToast('Gagal menyimpan data mahasiswa!', 'error');
            });
        }

        function updateMahasiswa() {
            const nama = document.getElementById('editNamaMahasiswa').value.trim();
            const email = document.getElementById('editEmailMahasiswa').value.trim();
            const whatsapp = document.getElementById('editWhatsAppMahasiswa').value.trim();
            const prodi = document.getElementById('editProdiMahasiswa').value;

            if (!nama || !email || !whatsapp || !prodi) {
                showToast('Semua field harus diisi!', 'error');
                return;
            }

            const mahasiswa = users.find(u => u.id === currentMahasiswaId);
            if (!mahasiswa) {
                showToast('Data mahasiswa tidak ditemukan!', 'error');
                return;
            }

            mahasiswa.name = nama;
            mahasiswa.email = email;
            mahasiswa.whatsapp = whatsapp;
            mahasiswa.prodi = prodi;
            
            addToSaveQueue(async () => {
                await saveUserDataToGitHub('users.json', JSON.stringify(users));
                await loadUserData(true);
                
                closeModal('editMahasiswaModal');
                showToast('Data mahasiswa berhasil diupdate!', 'success');
            }).catch(error => {
                console.error('Error in updateMahasiswa:', error);
                showToast('Gagal mengupdate data mahasiswa!', 'error');
            });
        }

        function deleteMahasiswa(id) {
            if (confirm('Apakah Anda yakin ingin menghapus data mahasiswa ini?')) {
                users = users.filter(u => u.id !== id);
                
                addToSaveQueue(async () => {
                    await saveUserDataToGitHub('users.json', JSON.stringify(users));
                    await loadUserData(true);
                    
                    showToast('Data mahasiswa berhasil dihapus!', 'success');
                }).catch(error => {
                    console.error('Error in deleteMahasiswa:', error);
                    showToast('Gagal menghapus data mahasiswa!', 'error');
                });
            }
        }

        function saveDosenBaru() {
            const nip = document.getElementById('nipBaru').value.trim();
            const nama = document.getElementById('namaDosenBaru').value.trim();
            const email = document.getElementById('emailDosenBaru').value.trim();
            const whatsapp = document.getElementById('whatsappDosenBaru').value.trim();
            const password = document.getElementById('passwordDosenBaru').value.trim();
            const confirmPassword = document.getElementById('confirmPasswordDosenBaru').value.trim();

            if (!nip || !nama || !email || !whatsapp || !password || !confirmPassword) {
                showToast('Semua field harus diisi!', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showToast('Password dan konfirmasi password tidak sama!', 'error');
                return;
            }

            if (users.some(u => u.id === nip)) {
                showToast('NIP/NIDN sudah terdaftar!', 'error');
                return;
            }

            const newDosen = {
                id: nip,
                name: nama,
                email: email,
                whatsapp: whatsapp,
                prodi: '-',
                password: password,
                role: 'dosen',
                createdAt: new Date().toISOString()
            };

            users.push(newDosen);
            
            addToSaveQueue(async () => {
                await saveUserDataToGitHub('users.json', JSON.stringify(users));
                await loadUserData(true);
                
                closeModal('tambahDosenModal');
                showToast('Data dosen berhasil ditambahkan!', 'success');
            }).catch(error => {
                console.error('Error in saveDosenBaru:', error);
                showToast('Gagal menyimpan data dosen!', 'error');
            });
        }

        function updateDosen() {
            const nama = document.getElementById('editNamaDosen').value.trim();
            const email = document.getElementById('editEmailDosen').value.trim();
            const whatsapp = document.getElementById('editWhatsAppDosen').value.trim();

            if (!nama || !email || !whatsapp) {
                showToast('Semua field harus diisi!', 'error');
                return;
            }

            const dosen = users.find(u => u.id === currentDosenId);
            if (!dosen) {
                showToast('Data dosen tidak ditemukan!', 'error');
                return;
            }

            dosen.name = nama;
            dosen.email = email;
            dosen.whatsapp = whatsapp;
            
            addToSaveQueue(async () => {
                await saveUserDataToGitHub('users.json', JSON.stringify(users));
                await loadUserData(true);
                
                closeModal('editDosenModal');
                showToast('Data dosen berhasil diupdate!', 'success');
            }).catch(error => {
                console.error('Error in updateDosen:', error);
                showToast('Gagal mengupdate data dosen!', 'error');
            });
        }

        function deleteDosen(id) {
            if (confirm('Apakah Anda yakin ingin menghapus data dosen ini?')) {
                users = users.filter(u => u.id !== id);
                
                addToSaveQueue(async () => {
                    await saveUserDataToGitHub('users.json', JSON.stringify(users));
                    await loadUserData(true);
                    
                    showToast('Data dosen berhasil dihapus!', 'success');
                }).catch(error => {
                    console.error('Error in deleteDosen:', error);
                    showToast('Gagal menghapus data dosen!', 'error');
                });
            }
        }

        function showEditMahasiswaForm(id) {
            if (!currentUser || currentUser.role !== 'admin') {
                showToast('Akses ditolak!', 'error');
                return;
            }
            
            const mahasiswa = users.find(u => u.id === id);
            if (!mahasiswa) {
                showToast('Data mahasiswa tidak ditemukan!', 'error');
                return;
            }
            
            currentMahasiswaId = id;
            document.getElementById('editNim').value = mahasiswa.id;
            document.getElementById('editNamaMahasiswa').value = mahasiswa.name;
            document.getElementById('editEmailMahasiswa').value = mahasiswa.email;
            document.getElementById('editWhatsAppMahasiswa').value = mahasiswa.whatsapp;
            document.getElementById('editProdiMahasiswa').value = mahasiswa.prodi;
            
            document.getElementById('editMahasiswaModal').classList.add('active');
        }

        function showEditDosenForm(id) {
            if (!currentUser || currentUser.role !== 'admin') {
                showToast('Akses ditolak!', 'error');
                return;
            }
            
            const dosen = users.find(u => u.id === id);
            if (!dosen) {
                showToast('Data dosen tidak ditemukan!', 'error');
                return;
            }
            
            currentDosenId = id;
            document.getElementById('editNip').value = dosen.id;
            document.getElementById('editNamaDosen').value = dosen.name;
            document.getElementById('editEmailDosen').value = dosen.email;
            document.getElementById('editWhatsAppDosen').value = dosen.whatsapp;
            
            document.getElementById('editDosenModal').classList.add('active');
        }

        function showTambahMahasiswaModal() {
            if (!currentUser || currentUser.role !== 'admin') {
                showToast('Akses ditolak!', 'error');
                return;
            }
            
            document.getElementById('nimBaru').value = '';
            document.getElementById('namaMahasiswaBaru').value = '';
            document.getElementById('emailMahasiswaBaru').value = '';
            document.getElementById('whatsappMahasiswaBaru').value = '';
            document.getElementById('prodiMahasiswaBaru').value = '';
            document.getElementById('passwordMahasiswaBaru').value = '';
            document.getElementById('confirmPasswordMahasiswaBaru').value = '';
            
            document.getElementById('tambahMahasiswaModal').classList.add('active');
        }

        function showTambahDosenModal() {
            if (!currentUser || currentUser.role !== 'admin') {
                showToast('Akses ditolak!', 'error');
                return;
            }
            
            document.getElementById('nipBaru').value = '';
            document.getElementById('namaDosenBaru').value = '';
            document.getElementById('emailDosenBaru').value = '';
            document.getElementById('whatsappDosenBaru').value = '';
            document.getElementById('passwordDosenBaru').value = '';
            document.getElementById('confirmPasswordDosenBaru').value = '';
            
            document.getElementById('tambahDosenModal').classList.add('active');
        }

        function showValidasiForm(proposalId) {
            if (!currentUser || currentUser.role !== 'admin') {
                showToast('Hanya admin yang dapat melakukan validasi!', 'error');
                return;
            }
            
            currentProposalId = proposalId;
            document.getElementById('validasiStatus').value = 'Diterima';
            document.getElementById('validasiKomentar').value = '';
            
            document.getElementById('validasiModal').classList.add('active');
        }

        function deleteProposal(id) {
            if (confirm('Apakah Anda yakin ingin menghapus proposal ini?')) {
                proposals = proposals.filter(p => p.id !== id);
                
                addToSaveQueue(async () => {
                    await saveProposalDataToGitHub();
                    showToast('Proposal berhasil dihapus!', 'success');
                }).catch(error => {
                    console.error('Error in deleteProposal:', error);
                    showToast('Gagal menghapus proposal!', 'error');
                });
            }
        }

        function exportData(type) {
            showToast(`Export data ${type} berhasil!`, 'success');
            
            let exportData = [];
            let filename = '';
            
            switch(type) {
                case 'proposal':
                    exportData = proposals.map(p => ({
                        NIM: p.nim,
                        Nama: p.nama,
                        Judul: p.judul,
                        Pembimbing1: p.pembimbing1,
                        Pembimbing2: p.pembimbing2,
                        Status: p.status,
                        Tanggal: new Date(p.tanggal).toLocaleDateString('id-ID')
                    }));
                    filename = `proposal_${new Date().toISOString().split('T')[0]}.json`;
                    break;
                case 'bimbingan':
                    exportData = bimbingans.map(b => ({
                        NIM: b.nim,
                        Nama: b.nama,
                        Judul: b.judul,
                        Bab: b.bab,
                        Status: b.status,
                        Dosen: b.dosen,
                        Tanggal: new Date(b.tanggal).toLocaleDateString('id-ID')
                    }));
                    filename = `bimbingan_${new Date().toISOString().split('T')[0]}.json`;
                    break;
                case 'mahasiswa':
                    exportData = users.filter(u => u.role === 'mahasiswa').map(m => ({
                        NIM: m.id,
                        Nama: m.name,
                        Email: m.email,
                        WhatsApp: m.whatsapp,
                        Prodi: m.prodi,
                        TanggalDaftar: new Date(m.createdAt).toLocaleDateString('id-ID')
                    }));
                    filename = `mahasiswa_${new Date().toISOString().split('T')[0]}.json`;
                    break;
                case 'dosen':
                    exportData = users.filter(u => u.role === 'dosen').map(d => ({
                        NIP: d.id,
                        Nama: d.name,
                        Email: d.email,
                        WhatsApp: d.whatsapp,
                        TanggalDaftar: new Date(d.createdAt).toLocaleDateString('id-ID')
                    }));
                    filename = `dosen_${new Date().toISOString().split('T')[0]}.json`;
                    break;
                case 'early-warning':
                    const mahasiswas = users.filter(u => u.role === 'mahasiswa');
                    const warningMahasiswas = mahasiswas.filter(mhs => {
                        const semester = getSemesterFromNIM(mhs.id);
                        if (semester < 11 || semester > 14) return false;
                        const hasCompleted = proposals.some(p => p.nim === mhs.id && p.status === 'Selesai');
                        return !hasCompleted;
                    }).map(m => ({
                        NIM: m.id,
                        Nama: m.name,
                        Prodi: m.prodi,
                        Semester: getSemesterFromNIM(m.id),
                        StatusSkripsi: proposals.some(p => p.nim === m.id && p.status === 'Selesai') ? 'Selesai' : 'Belum Selesai'
                    }));
                    exportData = warningMahasiswas;
                    filename = `early_warning_${new Date().toISOString().split('T')[0]}.json`;
                    break;
                case 'repository':
                    exportData = repositories.map(r => ({
                        Judul: r.judul,
                        Penulis: r.penulis,
                        Tahun: r.tahun,
                        Prodi: r.prodi,
                        Tanggal: new Date(r.tanggal).toLocaleDateString('id-ID')
                    }));
                    filename = `repository_${new Date().toISOString().split('T')[0]}.json`;
                    break;
            }
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function printData(type) {
            showToast(`Print data ${type} berhasil!`, 'success');
            window.print();
        }

        function searchRepository(query) {
            const tbody = document.getElementById('repositoryTableBody');
            if (!query) {
                displayRepositoryData();
                return;
            }
            
            const filtered = repositories.filter(r => 
                r.judul.toLowerCase().includes(query.toLowerCase()) ||
                r.penulis.toLowerCase().includes(query.toLowerCase()) ||
                r.prodi.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-search"></i>
                            <p>Tidak ada hasil yang ditemukan untuk "${query}"</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            filtered.forEach((repo, index) => {
                const row = document.createElement('tr');
                
                let actions = `
                    <div class="repository-actions">
                        <button class="btn-view" onclick="viewAbstract('${repo.id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn-upload" onclick="viewGoogleDrive('${repo.id}')">
                            <i class="fas fa-file-pdf"></i> Upload File
                        </button>
                `;
                
                if (currentUser && currentUser.role === 'admin') {
                    actions += `
                        <button class="btn-edit" onclick="editRepository('${repo.id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn-delete" onclick="deleteRepository('${repo.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                }
                
                actions += `</div>`;
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${repo.judul}</td>
                    <td>${repo.penulis}</td>
                    <td>${repo.tahun}</td>
                    <td>${repo.prodi}</td>
                    <td>${actions}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function exportExcel() {
            showToast('Mengekspor ke Excel...', 'warning');
            
            setTimeout(() => {
                showToast('Data berhasil di-export ke Excel!', 'success');
                
                const excelData = "Nama,NIM,Program Studi,Status\n" + 
                                 "Ahmad Fauzi,221101001,Ekonomi Syariah,Selesai\n" +
                                 "Budi Santoso,221101002,Perbankan Syariah,Dalam Proses\n" +
                                 "Dewi Lestari,221101003,Manajemen Bisnis Syariah,Menunggu Validasi";
                
                const blob = new Blob([excelData], { type: 'application/vnd.ms-excel' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `laporan_febi_${new Date().toISOString().split('T')[0]}.xls`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }, 500);
        }

        function exportCSV() {
            showToast('Mengekspor ke CSV...', 'warning');
            
            setTimeout(() => {
                showToast('Data berhasil di-export ke CSV!', 'success');
                
                const csvData = "Nama,NIM,Program Studi,Status\n" + 
                               "Ahmad Fauzi,221101001,Ekonomi Syariah,Selesai\n" +
                               "Budi Santoso,221101002,Perbankan Syariah,Dalam Proses\n" +
                               "Dewi Lestari,221101003,Manajemen Bisnis Syariah,Menunggu Validasi";
                
                const blob = new Blob([csvData], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `laporan_febi_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }, 500);
        }

        function printAllData() {
            showToast('Mempersiapkan data untuk print...', 'warning');
            
            const printStyle = `
                <style>
                    body { font-family: 'Poppins', sans-serif; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background-color: #2563eb; color: white; }
                    tr:nth-child(even) { background-color: #f9fafb; }
                    .header { text-align: center; margin-bottom: 30px; }
                    .header h1 { color: #2563eb; margin-bottom: 10px; }
                    .header p { color: #6b7280; }
                    .footer { text-align: center; margin-top: 50px; color: #6b7280; font-size: 12px; }
                </style>
            `;
            
            const printContent = `
                <div class="header">
                    <h1>LAPORAN SISTEM BIMBINGAN SKRIPSI</h1>
                    <p>Fakultas Ekonomi dan Bisnis Islam (FEBI)<br>UIN Sultan Idris Samarinda</p>
                    <p>Tanggal: ${new Date().toLocaleDateString('id-ID')}</p>
                </div>
                
                <h2>Data Proposal</h2>
                <table>
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>NIM</th>
                            <th>Nama</th>
                            <th>Judul</th>
                            <th>Status</th>
                            <th>Tanggal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${proposals.map((p, i) => `
                            <tr>
                                <td>${i+1}</td>
                                <td>${p.nim}</td>
                                <td>${p.nama}</td>
                                <td>${p.judul}</td>
                                <td>${p.status}</td>
                                <td>${new Date(p.tanggal).toLocaleDateString('id-ID')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <h2>Data Bimbingan</h2>
                <table>
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>NIM</th>
                            <th>Nama</th>
                            <th>Bab</th>
                            <th>Status</th>
                            <th>Tanggal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${bimbingans.map((b, i) => `
                            <tr>
                                <td>${i+1}</td>
                                <td>${b.nim}</td>
                                <td>${b.nama}</td>
                                <td>${b.bab}</td>
                                <td>${b.status}</td>
                                <td>${new Date(b.tanggal).toLocaleDateString('id-ID')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div class="footer">
                    <p>Dicetak pada: ${new Date().toLocaleString('id-ID')}</p>
                    <p> 2026 FEBI UINSI Samarinda - Managed by Iskandar</p>
                </div>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Laporan Bimbingan Skripsi</title>
                    ${printStyle}
                </head>
                <body onload="window.print(); setTimeout(() => window.close(), 1000);">
                    ${printContent}
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.classList.add('show');
            }
        }

        function forceRefresh() {
            dataCache = { users: null, proposals: null, bimbingans: null, repositories: null, lastUpdated: null };
            loadUserData(true);
            loadProposalData(true);
            loadBimbinganData(true);
            loadRepositoryData(true);
            showToast('Data berhasil di-refresh!', 'success');
        }
    </script>
</body>
</html>
